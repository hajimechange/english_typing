<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Typing Game</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 1200px;
            min-height: 80vh;
            margin: 40px auto;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 30px;
        }
        /* 単語表示エリアのカスタムスタイル */
        #word-display {
            font-family: 'Consolas', 'Courier New', monospace;
            min-height: 2.5em; 
            user-select: none;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; 
            line-height: 1.2;
            padding: 24px;
            text-align: center;
            word-break: break-word; 
            /* 瞬間英作文モード用のブランク文字のスタイル */
            letter-spacing: 0.1em;
        }
        @media (max-width: 768px) {
            #word-display {
                font-size: 1.5rem;
                padding: 16px;
            }
        }

        .correct { color: #10b981; } /* エメラルドグリーン */
        .incorrect { color: #ef4444; } /* 赤色 */
        .current-char { 
            background-color: #fef08a; /* 黄色のハイライト */
            border-radius: 4px;
            padding: 0 2px;
        }
        /* 瞬間英作文モードで未入力の文字に使うスタイル */
        .blank-char {
            color: #ccc;
        }
        .instant-mode-text {
            /* 瞬間英作文モードのテキストに特に強いフォントを適用 */
            font-size: 1.2rem;
            font-weight: 700;
            color: #4b5563; /* Gray-600 */
        }
    </style>
</head>
<body>

<div id="app" class="container flex flex-col items-center">
    <h1 class="text-4xl font-extrabold text-indigo-600 mb-8">
        English Typing Game
    </h1>

    <!-- 画面切り替えエリア -->
    <div id="screen-container" class="w-full">
        <!-- ホーム画面 (モード選択 + コース選択) -->
        <div id="home-screen" class="space-y-10">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-3">モード選択</h2>
            
            <!-- モード選択ボタン -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 通常モード -->
                <button onclick="selectMode('normal')" id="btn-normal" class="flex flex-col items-center justify-center p-8 bg-indigo-500 text-white rounded-xl shadow-xl hover:bg-indigo-600 transition-all transform hover:scale-105">
                    <p class="text-3xl font-extrabold mb-2">通常モード</p>
                    <p class="text-lg font-medium text-indigo-100">スペルを見ながら正確に打つ練習</p>
                </button>
                <!-- 瞬間英作文モード -->
                <button onclick="selectMode('instant')" id="btn-instant" class="flex flex-col items-center justify-center p-8 bg-purple-500 text-white rounded-xl shadow-xl hover:bg-purple-600 transition-all transform hover:scale-105">
                    <p class="text-3xl font-extrabold mb-2">瞬間英作文モード</p>
                    <p class="text-lg font-medium text-purple-100">日本語を見てスペルを思い出す練習 (高難度)</p>
                </button>
            </div>
            
            <h2 id="course-selection-title" class="text-2xl font-semibold text-gray-700 mt-10 hidden">コースを選んでください (<span id="selected-mode-display"></span>)</h2>

            <!-- コース選択 (3列グリッド) -->
            <div id="course-selection-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                <!-- 普通名詞セッション -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">普通名詞セッション</h3>
                    <div id="noun-courses" class="space-y-2"></div>
                </div>

                <!-- 一般動詞セッション -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">一般動詞セッション</h3>
                    <div id="verb-courses" class="space-y-2"></div>
                </div>
                
                <!-- 英文コースセッション (CSVデータに基づく固定文) -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">英文コースセッション (意味順ドリル)</h3>
                    <div id="sentence-courses" class="space-y-2">
                        <!-- 全9パターンのコース選択メニューが動的に挿入されます -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="hidden space-y-6">
            <div class="flex justify-between items-center w-full mb-4 p-4 bg-indigo-50 rounded-lg shadow-inner">
                <p class="text-lg font-bold text-indigo-700">
                    モード: <span id="current-mode-display"></span> | コース: <span id="current-course-display"></span>
                </p>
                <div class="text-2xl font-extrabold text-red-600 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    残り時間: <span id="timer" class="ml-1">60</span>秒
                </div>
            </div>
            
            <!-- スコア・情報エリア -->
            <div class="flex justify-around text-center mb-6">
                <div class="p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-sm text-green-700">スコア</p>
                    <p id="score" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="p-3 bg-red-100 rounded-lg shadow-md">
                    <p class="text-sm text-red-700">ミスタイプ</p>
                    <p id="mistake-count" class="text-3xl font-bold text-red-600">0</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-lg shadow-md">
                    <p class="text-sm text-yellow-700">問題</p>
                    <p id="word-progress" class="text-3xl font-bold text-yellow-600">0/0</p>
                </div>
            </div>

            <!-- 単語とUIエリア -->
            <div class="flex flex-col items-center space-y-6 w-full"> 
                
                <!-- 1. 英単語/英文表示エリア (最上部) -->
                <div id="word-display" class="font-extrabold tracking-wider p-6 bg-gray-50 rounded-xl w-full text-center shadow-inner min-h-[3.5em]">
                    Loading...
                </div>
                
                <!-- 2. 日本語の意味 (大きく表示) -->
                <p id="word-meaning" class="text-4xl font-extrabold text-gray-800 mb-4 p-2">日本語の意味</p>
                
                <!-- 3. 入力ボックス -->
                <input type="text" id="typing-input" placeholder="タイプを開始してください" class="w-full md:w-3/4 p-4 text-2xl text-center border-4 border-indigo-400 rounded-xl focus:border-indigo-600 outline-none transition-all duration-300" autofocus disabled>
            </div>
            
            <p id="feedback-message" class="text-center text-lg h-6"></p>

            <button onclick="changeScreen('home')" class="mt-4 px-6 py-2 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors">
                ホームに戻る
            </button>
        </div>
        
        <!-- 結果画面 -->
        <div id="result-screen" class="hidden space-y-6 text-center">
            <h2 class="text-4xl font-extrabold text-green-600">ゲーム終了！</h2>
            <p class="text-2xl text-gray-700">
                あなたの最終スコアは: <span id="final-score" class="text-indigo-600 font-extrabold text-5xl">0</span> ポイントです
            </p>
            <p class="text-xl text-gray-600">
                <span id="completed-words">0</span> / <span id="total-words">0</span> 問題を完了しました。
            </p>
            <button onclick="startGame(GAME_STATE.currentMode, GAME_STATE.selectedSession, GAME_STATE.selectedCourse)" class="mt-8 px-8 py-4 bg-indigo-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">
                このコースで再チャレンジ！
            </button>
            <button onclick="changeScreen('home')" class="mt-4 px-6 py-3 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors block mx-auto">
                コース選択に戻る
            </button>
        </div>
        
    </div>
</div>

<script>
// =========================================================
// 1. データ定義 (英単語 + 英文 全てのコースを固定文で構成)
// CSVデータから抽出した全9パターンの英文180問をここに格納します。
// =========================================================

const WORD_DATA = {
    // スタンダードな単語セッションはそのまま維持
    "普通名詞セッション": {
        "動物": [
            { word: "dog", meaning: "犬" }, { word: "cat", meaning: "猫" }, { word: "bird", meaning: "鳥" }, { word: "fish", meaning: "魚" }, { word: "horse", meaning: "馬" },
            { word: "lion", meaning: "ライオン" }, { word: "tiger", meaning: "トラ" }, { word: "bear", meaning: "熊" }, { word: "monkey", meaning: "猿" }, { word: "rabbit", meaning: "ウサギ" },
            { word: "mouse", meaning: "ネズミ" }, { word: "sheep", meaning: "羊" }, { word: "goat", meaning: "ヤギ" }, { word: "pig", meaning: "豚" }, { word: "cow", meaning: "牛" },
            { word: "snake", meaning: "蛇" }, { word: "spider", meaning: "クモ" }, { word: "whale", meaning: "クジラ" }, { word: "dolphin", meaning: "イルカ" }, { word: "penguin", meaning: "ペンギン" }
        ],
        "食べ物": [
            { word: "apple", meaning: "りんご" }, { word: "banana", meaning: "バナナ" }, { word: "orange", meaning: "オレンジ" }, { word: "grape", meaning: "ぶどう" }, { word: "rice", meaning: "ご飯" },
            { word: "bread", meaning: "パン" }, { word: "meat", meaning: "肉" }, { word: "egg", meaning: "卵" }, { word: "cheese", meaning: "チーズ" }, { word: "milk", meaning: "牛乳" },
            { word: "pizza", meaning: "ピザ" }, { word: "sushi", meaning: "寿司" }, { word: "salad", meaning: "サラダ" }, { word: "soup", meaning: "スープ" }, { word: "curry", meaning: "カレー" },
            { word: "water", meaning: "水" }, { word: "juice", meaning: "ジュース" }, { word: "coffee", meaning: "コーヒー" }, { word: "sugar", meaning: "砂糖" }, { word: "salt", meaning: "塩" }
        ],
        "家具": [
            { word: "chair", meaning: "椅子" }, { word: "table", meaning: "テーブル" }, { word: "bed", meaning: "ベッド" }, { word: "sofa", meaning: "ソファ" }, { word: "desk", meaning: "机" },
            { word: "shelf", meaning: "棚" }, { word: "lamp", meaning: "ランプ" }, { word: "mirror", meaning: "鏡" }, { word: "clock", meaning: "時計" }, { word: "drawer", meaning: "引き出し" },
            { word: "rug", meaning: "ラグ" }, { word: "door", meaning: "ドア" }, { word: "window", meaning: "窓" }, { word: "curtain", meaning: "カーテン" }, { word: "carpet", meaning: "カーペット" },
            { word: "heater", meaning: "暖房" }, { word: "fan", meaning: "扇風機" }, { word: "picture", meaning: "絵" }, { word: "vases", meaning: "花瓶" }, { word: "cabinet", meaning: "戸棚" }
        ],
        "筆記用具": [
            { word: "pen", meaning: "ペン" }, { word: "pencil", meaning: "鉛筆" }, { word: "eraser", meaning: "消しゴム" }, { word: "notebook", meaning: "ノート" }, { word: "ruler", meaning: "定規" },
            { word: "book", meaning: "本" }, { word: "paper", meaning: "紙" }, { word: "stapler", meaning: "ホッチキス" }, { word: "scissors", meaning: "ハサミ" }, { word: "glue", meaning: "のり" },
            { word: "folder", meaning: "ファイル" }, { word: "marker", meaning: "マーカー" }, { word: "crayon", meaning: "クレヨン" }, { word: "ink", meaning: "インク" }, { word: "clipboard", meaning: "クリップボード" },
            { word: "tape", meaning: "テープ" }, { word: "chalk", meaning: "チョーク" }, { word: "compass", meaning: "コンパス" }, { word: "binder", meaning: "バインダー" }, { word: "highlighter", meaning: "蛍光ペン" }
        ],
        "色": [
            { word: "red", meaning: "赤" }, { word: "blue", meaning: "青" }, { word: "green", meaning: "緑" }, { word: "yellow", meaning: "黄" }, { word: "black", meaning: "黒" },
            { word: "white", meaning: "白" }, { word: "pink", meaning: "ピンク" }, { word: "brown", meaning: "茶色" }, { word: "gray", meaning: "灰色" }, { word: "purple", meaning: "紫" },
            { word: "orange", meaning: "オレンジ" }, { word: "gold", meaning: "金色" }, { word: "silver", meaning: "銀色" }, { word: "navy", meaning: "紺色" }, { word: "beige", meaning: "ベージュ" },
            { word: "sky", meaning: "空色" }, { word: "deep", meaning: "濃い" }, { word: "light", meaning: "薄い" }, { word: "colorful", meaning: "カラフル" }, { word: "transparent", meaning: "透明" }
        ],
        "天気": [
            { word: "sun", meaning: "太陽" }, { word: "rain", meaning: "雨" }, { word: "snow", meaning: "雪" }, { word: "wind", meaning: "風" }, { word: "cloud", meaning: "雲" },
            { word: "storm", meaning: "嵐" }, { word: "fog", meaning: "霧" }, { word: "clear", meaning: "晴れた" }, { word: "warm", meaning: "暖かい" }, { word: "cold", meaning: "寒い" },
            { word: "humid", meaning: "湿気た" }, { word: "forecast", meaning: "予報" }, { word: "rainbow", meaning: "虹" }, { word: "thunder", meaning: "雷" }, { word: "lightning", meaning: "稲妻" },
            { word: "hail", meaning: "ひょう" }, { word: "breeze", meaning: "そよ風" }, { word: "typhoon", meaning: "台風" }, { word: "drizzle", meaning: "霧雨" }, { word: "overcast", meaning: "曇りの" }
        ],
        "体の部位": [
            { word: "head", meaning: "頭" }, { word: "face", meaning: "顔" }, { word: "eye", meaning: "目" }, { word: "ear", meaning: "耳" }, { word: "nose", meaning: "鼻" },
            { word: "mouth", meaning: "口" }, { word: "hand", meaning: "手（手首から下）" }, { word: "foot", meaning: "足（足首から下）" }, { word: "arm", meaning: "腕" }, { word: "leg", meaning: "脚" },
            { word: "stomach", meaning: "胃/腹" }, { word: "neck", meaning: "首" }, { word: "back", meaning: "背中" }, { word: "finger", meaning: "指" }, { word: "hair", meaning: "髪" },
            { word: "teeth", meaning: "歯" }, { word: "shoulder", meaning: "肩" }, { word: "chest", meaning: "胸" }, { word: "knee", meaning: "ひざ" }, { word: "skin", meaning: "肌" }
        ],
        "学校に関するもの": [
            { word: "school", meaning: "学校" }, { word: "teacher", meaning: "先生" }, { word: "student", meaning: "生徒" }, { word: "class", meaning: "授業/クラス" }, { word: "lesson", meaning: "課/レッスン" },
            { word: "homework", meaning: "宿題" }, { word: "test", meaning: "テスト" }, { word: "exam", meaning: "試験" }, { word: "library", meaning: "図書館" }, { word: "gym", meaning: "体育館" },
            { word: "uniform", meaning: "制服" }, { word: "break", meaning: "休み時間" }, { word: "club", meaning: "部活" }, { word: "friend", meaning: "友達" }, { word: "study", meaning: "勉強" },
            { word: "subject", meaning: "科目" }, { word: "history", meaning: "歴史" }, { word: "science", meaning: "科学" }, { word: "math", meaning: "数学" }, { word: "sport", meaning: "スポーツ" }
        ]
    },
    "一般動詞セッション": {
        "コーパストップ２０": [
            { word: "say", meaning: "言う" }, { word: "get", meaning: "得る" }, { word: "make", meaning: "作る" }, { word: "go", meaning: "行く" }, { word: "know", meaning: "知る" },
            { word: "take", meaning: "取る" }, { word: "see", meaning: "見る" }, { word: "come", meaning: "来る" }, { word: "think", meaning: "考える" }, { word: "look", meaning: "見る" },
            { word: "want", meaning: "欲しい" }, { word: "give", meaning: "与える" }, { word: "use", meaning: "使う" }, { word: "find", meaning: "見つける" }, { word: "tell", meaning: "話す" },
            { word: "ask", meaning: "尋ねる" }, { word: "work", meaning: "働く" }, { word: "seem", meaning: "〜のようだ" }, { word: "feel", meaning: "感じる" }, { word: "try", meaning: "試す" }
        ],
        "コーパストップ２０〜４０": [
            { word: "leave", meaning: "去る" }, { word: "call", meaning: "呼ぶ" }, { word: "need", meaning: "必要とする" }, { word: "become", meaning: "〜になる" }, { word: "put", meaning: "置く" },
            { word: "mean", meaning: "意味する" }, { word: "keep", meaning: "保つ" }, { word: "let", meaning: "許可する" }, { word: "begin", meaning: "始める" }, { word: "help", meaning: "助ける" },
            { word: "turn", meaning: "曲がる" }, { word: "start", meaning: "始める" }, { word: "show", meaning: "示す" }, { word: "hear", meaning: "聞く" }, { word: "play", meaning: "遊ぶ" },
            { word: "run", meaning: "走る" }, { word: "move", meaning: "動く" }, { word: "like", meaning: "好きだ" }, { word: "live", meaning: "住む" }, { word: "believe", meaning: "信じる" }
        ],
        "コーパストップ４０〜６０": [
            { word: "bring", meaning: "持ってくる" }, { word: "happen", meaning: "起こる" }, { word: "write", meaning: "書く" }, { word: "provide", meaning: "提供する" }, { word: "sit", meaning: "座る" },
            { word: "stand", meaning: "立つ" }, { word: "lose", meaning: "失う" }, { word: "pay", meaning: "支払う" }, { word: "meet", meaning: "会う" }, { word: "include", meaning: "含む" },
            { word: "continue", meaning: "続ける" }, { word: "set", meaning: "設定する" }, { word: "learn", meaning: "学ぶ" }, { word: "change", meaning: "変える" }, { word: "wait", meaning: "待つ" },
            { word: "watch", meaning: "見守る" }, { word: "follow", meaning: "従う" }, { word: "stop", meaning: "止める" }, { word: "create", meaning: "創造する" }, { word: "speak", meaning: "話す" }
        ],
        "コーパストップ６０〜８０": [
            { word: "read", meaning: "読む" }, { word: "allow", meaning: "許す" }, { word: "add", meaning: "加える" }, { word: "spend", meaning: "費やす" }, { word: "grow", meaning: "育つ" },
            { word: "open", meaning: "開ける" }, { word: "walk", meaning: "歩く" }, { word: "win", meaning: "勝つ" }, { word: "offer", meaning: "提供する" }, { word: "remember", meaning: "思い出す" },
            { word: "love", meaning: "愛する" }, { word: "consider", meaning: "検討する" }, { word: "buy", meaning: "買う" }, { word: "serve", meaning: "奉仕する" }, { word: "die", meaning: "死ぬ" },
            { word: "send", meaning: "送る" }, { word: "build", meaning: "建てる" }, { word: "stay", meaning: "留まる" }, { word: "fall", meaning: "落ちる" }, { word: "cut", meaning: "切る" }
        ],
        "コーパストップ８０〜１００": [
            { word: "reach", meaning: "達する" }, { word: "kill", meaning: "殺す" }, { word: "raise", meaning: "上げる" }, { word: "pass", meaning: "通り過ぎる" }, { word: "sell", meaning: "売る" },
            { word: "decide", meaning: "決定する" }, { word: "return", meaning: "戻る" }, { word: "explain", meaning: "説明する" }, { word: "hope", meaning: "望む" }, { word: "develop", meaning: "発展させる" },
            { word: "carry", meaning: "運ぶ" }, { word: "break", meaning: "壊す" }, { word: "receive", meaning: "受け取る" }, { word: "agree", meaning: "同意する" }, { word: "support", meaning: "支援する" },
            { word: "hit", meaning: "打つ" }, { word: "end", meaning: "終わる" }, { word: "save", meaning: "救う" }, { word: "drive", meaning: "運転する" }, { word: "remain", meaning: "残る" }
        ]
    },
    
    // === 英文コースセッション (CSVデータに基づく固定文: 全9パターン, 180問) ===
    "英文コースセッション": {
        "パターン１：「誰が(S)」「する(V)」（S + V / S + V + C）": [
            { word: "I am Edward Trout.", meaning: "私はエドワード・トラウトです。" },
            { word: "Are you an anime fan?", meaning: "あなたはアニメのファンですか。" },
            { word: "Be brave.", meaning: "勇気を出して。" },
            { word: "Don't worry.", meaning: "心配しないで。" },
            { word: "The children look happy.", meaning: "子供たちは幸せそうに見えます。" },
            { word: "Talking with him was fun.", meaning: "彼と話すことは楽しかったです。" },
            { word: "My sister sings well.", meaning: "私の姉は歌が上手です。" },
            { word: "The sky is blue.", meaning: "空は青いです。" },
            { word: "She became a teacher.", meaning: "彼女は先生になりました。" },
            { word: "We work hard.", meaning: "私たちは一生懸命働きます。" },
            { word: "The door opened.", meaning: "ドアが開きました。" },
            { word: "The food tastes salty.", meaning: "その食べ物は塩辛い味がします。" },
            { word: "Everyone smiled.", meaning: "みんなが微笑みました。" },
            { word: "You should be careful.", meaning: "あなたは注意すべきです。" },
            { word: "They are quiet.", meaning: "彼らは静かです。" },
            { word: "He seems nice.", meaning: "彼は優しそうだ。" },
            { word: "Keep quiet.", meaning: "静かにしなさい。" },
            { word: "The river flows quickly.", meaning: "その川は速く流れる。" },
            { word: "I feel tired.", meaning: "私は疲れていると感じる。" },
            { word: "Let's sing together.", meaning: "一緒に歌いましょう。" }
        ],
        "パターン２：「誰が(S)」「する(V)」「何を(O)」（S + V + O）": [
            { word: "I like Japanese sweets.", meaning: "私は日本の甘い菓子が好きです。" },
            { word: "Do you like rugby?", meaning: "あなたはラグビーが好きですか。" },
            { word: "I do not play rugby.", meaning: "私はラグビーをしません。" },
            { word: "We bought a new car.", meaning: "私たちは新しい車を買いました。" },
            { word: "He speaks English well.", meaning: "彼は英語を上手に話します。" },
            { word: "She is eating lunch now.", meaning: "彼女は今、昼食を食べています。" },
            { word: "Did you see the movie?", meaning: "あなたはその映画を見ましたか。" },
            { word: "I will write a letter tomorrow.", meaning: "私は明日、手紙を書くつもりです。" },
            { word: "She must finish her homework.", meaning: "彼女は宿題を終えなければならない。" },
            { word: "I have to call him later.", meaning: "私は後で彼に電話しなければならない。" },
            { word: "Reading books is fun.", meaning: "本を読むことは楽しい。" },
            { word: "They enjoyed hiking.", meaning: "彼らはハイキングを楽しみました。" },
            { word: "He wants to buy a dog.", meaning: "彼は犬を買いたがっている。" },
            { word: "I need to study hard.", meaning: "私は一生懸命勉強する必要がある。" },
            { word: "I want you to help me.", meaning: "私はあなたに私を手伝ってほしい。" },
            { word: "The government decided to stop the plan.", meaning: "政府はその計画を中止することを決定した。" },
            { word: "I like to listen to music.", meaning: "私は音楽を聴くことが好きです。" },
            { word: "He gave up smoking.", meaning: "彼は喫煙をやめました。" },
            { word: "She knows how to cook Japanese food.", meaning: "彼女は日本食の調理方法を知っている。" },
            { word: "I cannot make shumai.", meaning: "私はシュウマイを作ることができません。" }
        ],
        "パターン３：「誰が(S)」「する(V)」「誰に(O)」「何を(O)」（S + V + O + O）": [
            { word: "My father gave me a new bike.", meaning: "私の父は私に新しい自転車をくれました。" },
            { word: "She showed us her photos.", meaning: "彼女は私たちに彼女の写真を見せました。" },
            { word: "I bought my sister a present.", meaning: "私は姉にプレゼントを買いました。" },
            { word: "He taught me English.", meaning: "彼は私に英語を教えてくれました。" },
            { word: "Can you lend me some money?", meaning: "私にお金を貸してもらえますか。" },
            { word: "I told him the truth.", meaning: "私は彼に真実を話しました。" },
            { word: "Please send me an email.", meaning: "私にEメールを送ってください。" },
            { word: "I will make you some coffee.", meaning: "私はあなたにコーヒーを淹れてあげます。" },
            { word: "He passed me the salt.", meaning: "彼は私に塩を手渡しました。" },
            { word: "They offered him a good job.", meaning: "彼らは彼に良い仕事を提供した。" },
            { word: "We wish you a happy new year.", meaning: "私たちはあなたに幸せな新年を願っています。" },
            { word: "She asked me a question.", meaning: "彼女は私に質問をしました。" },
            { word: "I owe you $10.", meaning: "私はあなたに10ドル借りています。" },
            { word: "Read me a story.", meaning: "私に物語を読んでください。" },
            { word: "He brought his children gifts.", meaning: "彼は子供たちに贈り物を買ってきました。" },
            { word: "I found my dog a toy.", meaning: "私は犬に新しいおもちゃを見つけてあげました。" },
            { word: "Tell me what you have done.", meaning: "あなた(たち)が何をしたところかを教えてください。" },
            { word: "We cooked them dinner.", meaning: "私たちは彼らに夕食を作りました。" },
            { word: "Will you buy me this book?", meaning: "私にこの本を買ってくれますか。" },
            { word: "He saved me a seat.", meaning: "彼は私の席を取っておいてくれました。" }
        ],
        "パターン４：「誰が(S)」「する(V)」「何を(O)」「どこに（A）」（S + V + O + A）": [
            { word: "I put the book on the table.", meaning: "私はテーブルの上に本を置きました。" },
            { word: "She took her dog to the park.", meaning: "彼女は犬を公園に連れて行きました。" },
            { word: "We found the keys in the drawer.", meaning: "私たちは引き出しの中に鍵を見つけました。" },
            { word: "He hung the picture on the wall.", meaning: "彼は壁に絵を掛けました。" },
            { word: "Don't leave the door open.", meaning: "ドアを開けっ放しにしないでください。" },
            { word: "She kept the children happy.", meaning: "彼女は子供たちを幸せな状態に保った。" },
            { word: "They made him their leader.", meaning: "彼らは彼を自分たちのリーダーにした。" },
            { word: "I consider her my best friend.", meaning: "私は彼女を親友だと思っています。" },
            { word: "We paint the house white.", meaning: "私たちは家を白く塗ります。" },
            { word: "I saw him run away.", meaning: "私は彼が逃げ去るのを見た。" },
            { word: "She heard me call her name.", meaning: "彼女は私が彼女の名前を呼ぶのを聞いた。" },
            { word: "I want my coffee hot.", meaning: "私はコーヒーを熱い状態で飲みたい。" },
            { word: "The news made me sad.", meaning: "そのニュースは私を悲しくさせた。" },
            { word: "I had my hair cut.", meaning: "私は髪を切ってもらった。" },
            { word: "I got my computer fixed.", meaning: "私はコンピューターを修理してもらった。" },
            { word: "I want the work finished by Friday.", meaning: "私は金曜日までにその仕事を終えてほしい。" },
            { word: "The wind made the window open.", meaning: "風が窓を開けさせた。" },
            { word: "She believes him honest.", meaning: "彼女は彼が正直だと信じている。" },
            { word: "I found the task easy.", meaning: "私はその課題が簡単だとわかった。" },
            { word: "He often drives the car too fast.", meaning: "彼はしばしば車を速く運転しすぎる。" }
        ],
        "パターン５：関係詞（Who / Which / That）": [
            { word: "The woman smiling in a kimono is Taylor.", meaning: "着物を着てほほえんでいる女性はテイラーです。" },
            { word: "Gandhi is a man who has influenced a lot of people.", meaning: "ガンディーは多くの人々に影響を与えた人です。" },
            { word: "This is a movie that makes people happy.", meaning: "これは人々を幸せにする映画です。" },
            { word: "This is a picture that I found on the internet.", meaning: "これは私がインターネットで見つけた写真です。" },
            { word: "Many things that we see every day come from overseas.", meaning: "私たちが毎日目にする多くのものは海外から来ています。" },
            { word: "There is a movie called Live Your Dream.", meaning: "「Live Your Dream (夢を生きる)」と呼ばれる映画があります。" },
            { word: "I wish I had pens and notebooks.", meaning: "ノートやペンを持っていればいいのになあ。" },
            { word: "I know a man who can speak five languages.", meaning: "私は5ヶ国語を話せる男性を知っています。" },
            { word: "She is the artist whose painting I bought.", meaning: "彼女は私が絵を買ったアーティストです。" },
            { word: "I live in a town which is famous for its cheese.", meaning: "私はチーズで有名な町に住んでいます。" },
            { word: "This is the place where we first met.", meaning: "ここは私たちが初めて会った場所です。" },
            { word: "Do you remember the day when we went to Kyoto?", meaning: "私たちが京都へ行った日を覚えていますか。" },
            { word: "The reason why I came here is to talk to you.", meaning: "私がここに来た理由はあなたと話すことです。" },
            { word: "The girl wearing a red hat is my cousin.", meaning: "赤い帽子をかぶっている女の子は私のいとこです。" },
            { word: "He is the only person who knows the secret.", meaning: "彼はその秘密を知っている唯一の人だ。" },
            { word: "I couldn't hear what he said.", meaning: "私は彼が言ったことを聞き取れませんでした。" },
            { word: "Tell me what you think.", meaning: "あなたがどう思うか教えてください。" },
            { word: "This is the pen with which I write my novel.", meaning: "これは私が小説を書くのに使うペンです。" },
            { word: "He is the man to whom I gave the book.", meaning: "彼が私がその本をあげた男性です。" },
            { word: "That is the most beautiful flower I have ever seen.", meaning: "あれは私が今まで見た中で最も美しい花です。" }
        ],
        "パターン６：比較（as...as / more...than / the most）": [
            { word: "My sister is as tall as me.", meaning: "私の姉は私と同じくらい背が高い。" },
            { word: "He is taller than his brother.", meaning: "彼は彼の弟より背が高い。" },
            { word: "This is the oldest temple in Kyoto.", meaning: "これは京都で最も古い寺です。" },
            { word: "She runs faster than I do.", meaning: "彼女は私よりも速く走る。" },
            { word: "This book is more interesting than that one.", meaning: "この本はあの本よりもっと面白い。" },
            { word: "It was the most exciting game I have ever watched.", meaning: "それは私が今まで見た中で最もわくわくする試合だった。" },
            { word: "I can't run as fast as you.", meaning: "私はあなたほど速く走れません。" },
            { word: "The more you practice, the better you become.", meaning: "練習すればするほど、上手になる。" },
            { word: "He has as many books as I do.", meaning: "彼は私と同じくらいの数の本を持っている。" },
            { word: "The population of Tokyo is larger than that of Osaka.", meaning: "東京の人口は大阪の人口よりも多い。" },
            { word: "I like coffee better than tea.", meaning: "私は紅茶よりもコーヒーが好きです。" },
            { word: "She is one of the best singers in the world.", meaning: "彼女は世界で最も歌が上手な歌手の一人だ。" },
            { word: "English is the most important subject for me.", meaning: "私にとって英語が最も重要な科目だ。" },
            { word: "He looks much happier than yesterday.", meaning: "彼は昨日よりもずっと幸せそうだ。" },
            { word: "The food was less salty than I expected.", meaning: "その食べ物は私が期待していたほど塩辛くなかった。" },
            { word: "Nothing is more important than health.", meaning: "健康よりも大切なものはない。" },
            { word: "I got up as early as possible.", meaning: "私はできるだけ早く起きた。" },
            { word: "He ate twice as much as I did.", meaning: "彼は私の2倍の量を食べた。" },
            { word: "She is not only smart but also kind.", meaning: "彼女は賢いだけでなく、優しい。" },
            { word: "I prefer dogs to cats.", meaning: "私は猫よりも犬が好きだ。" }
        ],
        "パターン７：受動態（Be + 過去分詞）": [
            { word: "This movie was directed by a famous director.", meaning: "この映画は有名な監督によって監督された。" },
            { word: "English is spoken in many countries.", meaning: "英語は多くの国で話されている。" },
            { word: "The window was broken by the children.", meaning: "窓は子供たちによって割られました。" },
            { word: "A new library will be built next year.", meaning: "新しい図書館は来年建設されるだろう。" },
            { word: "The cake was made by my mother.", meaning: "そのケーキは私の母によって作られた。" },
            { word: "The problem has been solved.", meaning: "その問題は解決された。" },
            { word: "He was surprised at the news.", meaning: "彼はそのニュースに驚いた。" },
            { word: "She is interested in Japanese culture.", meaning: "彼女は日本文化に興味がある。" },
            { word: "I am worried about my exam.", meaning: "私は試験のことが心配だ。" },
            { word: "The stadium is always crowded with people.", meaning: "そのスタジアムはいつも人々で混雑している。" },
            { word: "He was known to everyone in the town.", meaning: "彼は町のみんなに知られていた。" },
            { word: "The door must be kept locked.", meaning: "ドアは鍵をかけておかなければならない。" },
            { word: "You must be treated kindly.", meaning: "あなたは親切に扱われるべきだ。" },
            { word: "We were told to wait outside.", meaning: "私たちは外で待つように言われた。" },
            { word: "The house was built 50 years ago.", meaning: "その家は50年前に建てられた。" },
            { word: "Is this book read by many students?", meaning: "この本は多くの生徒に読まれていますか。" },
            { word: "The letter was written in English.", meaning: "その手紙は英語で書かれていた。" },
            { word: "They were given some advice.", meaning: "彼らはいくつかアドバイスを与えられた。" },
            { word: "A new hospital is being constructed now.", meaning: "新しい病院が今、建設中です。" },
            { word: "It is said that he is a genius.", meaning: "彼は天才だと言われている。" }
        ],
        "パターン８：to不定詞（名詞的・形容詞的・副詞的）": [
            { word: "My dream is to travel around the world.", meaning: "私の夢は世界中を旅することです。" },
            { word: "I want to buy a new computer.", meaning: "私は新しいコンピューターを買いたい。" },
            { word: "It is easy to learn Japanese.", meaning: "日本語を学ぶのは簡単です。" },
            { word: "I have a lot of homework to do.", meaning: "私にはするべき宿題がたくさんある。" },
            { word: "She has no friends to talk with.", meaning: "彼女には一緒に話す友達がいない。" },
            { word: "We went to the park to play soccer.", meaning: "私たちはサッカーをするために公園へ行きました。" },
            { word: "He studied hard to pass the exam.", meaning: "彼は試験に合格するために一生懸命勉強した。" },
            { word: "I was surprised to hear the news.", meaning: "私はそのニュースを聞いて驚いた。" },
            { word: "You must be tired to say such a thing.", meaning: "そんなことを言うなんて、あなたは疲れているに違いない。" },
            { word: "He grew up to be a doctor.", meaning: "彼は成長して医者になった。" },
            { word: "I decided not to go there.", meaning: "私はそこに行かないことを決めた。" },
            { word: "To tell the truth, I don't like natto.", meaning: "実を言うと、私は納豆が好きではない。" },
            { word: "I don't know what to do next.", meaning: "次に何をすべきか私にはわからない。" },
            { word: "The boy needs someone to play with.", meaning: "その男の子には一緒に遊ぶ誰かが必要だ。" },
            { word: "It is important for us to learn history.", meaning: "私たちにとって歴史を学ぶことは重要です。" },
            { word: "She seems to be rich.", meaning: "彼女は裕福なようだ。" },
            { word: "They plan to visit Kyoto next month.", meaning: "彼らは来月、京都を訪れる予定だ。" },
            { word: "I have nothing to talk about.", meaning: "私には話すことが何もない。" },
            { word: "I have too much work to do.", meaning: "私にはすることが多すぎる。" },
            { word: "He is old enough to drive a car.", meaning: "彼は車を運転できる年齢だ。" }
        ],
        "パターン９：接続詞・従属節（When / If / That / Because / Although など）": [
            { word: "When I came home, my mother was cooking dinner.", meaning: "私が家に帰ったとき、母は夕食を作っていた。" },
            { word: "If it rains tomorrow, we will stay home.", meaning: "もし明日雨が降れば、私たちは家にいるだろう。" },
            { word: "I think that he is honest.", meaning: "私は彼が正直だと思います。" },
            { word: "Because I was tired, I went to bed early.", meaning: "疲れていたので、私は早く寝ました。" },
            { word: "Although it was cold, we went swimming.", meaning: "寒かったけれど、私たちは泳ぎに行った。" },
            { word: "She said that she would help me.", meaning: "彼女は私を手伝うだろうと言った。" },
            { word: "Tell me when you will come.", meaning: "あなたがいつ来るか教えてください。" },
            { word: "I don't know if he is coming.", meaning: "彼が来るかどうか私にはわからない。" },
            { word: "The news that he won the lottery is true.", meaning: "彼が宝くじに当たったというニュースは本当だ。" },
            { word: "She is working hard so that she can buy a house.", meaning: "彼女は家を買えるように一生懸命働いている。" },
            { word: "I will wait until you come back.", meaning: "あなたが戻ってくるまで待っています。" },
            { word: "He left before I woke up.", meaning: "彼が目を覚ます前に彼は出かけた。" },
            { word: "It has been raining since last night.", meaning: "昨夜から雨が降り続いている。" },
            { word: "I will go even if it snows.", meaning: "たとえ雪が降っても私は行きます。" },
            { word: "I am sure that she will succeed.", meaning: "私は彼女が成功すると確信している。" },
            { word: "The problem is that we don't have enough money.", meaning: "問題は私たちにお金が十分ないことです。" },
            { word: "As soon as I arrived, I called her.", meaning: "到着するやいなや、私は彼女に電話した。" },
            { word: "He looks as if he were ill.", meaning: "彼は病気であるかのように見える。" },
            { word: "I don't know why he is angry.", meaning: "彼がなぜ怒っているのか私にはわからない。" },
            { word: "Whether you like it or not, you have to do it.", meaning: "好きであろうとなかろうと、あなたはそれをしなければならない。" }
        ],
        "仮定法（If S were / I wish など）": [
            { word: "If I were an animal, I would be a dolphin.", meaning: "もし私が動物なら、イルカになるでしょう。" },
            { word: "If she were here, she would know what to do.", meaning: "もし彼女がここにいれば、何をすべきかわかるだろうに。" },
            { word: "He acts as if he were a leader.", meaning: "彼はまるでリーダーであるかのように振る舞います。" },
            { word: "If it were sunny, we could go hiking.", meaning: "もし晴れていたら、ハイキングに行けるのに。" },
            { word: "I wish I didn't have to work this weekend.", meaning: "今週末、仕事をしなくて済めばいいのに。" },
            { word: "What would you do if you won the lottery?", meaning: "もし宝くじに当たったら、何をしますか。" },
            { word: "If they changed the rule, the game would be better.", meaning: "もし彼らがルールを変えたら、試合はもっとよくなるだろうに。" },
            { word: "I wish I knew the answer to that question.", meaning: "あの質問の答えを知っていればいいのに。" },
            { word: "If I spoke French, I could live in Paris.", meaning: "もし私がフランス語を話せたら、パリに住めるのに。" },
            { word: "She looked as if she hadn't slept for days.", meaning: "彼女はまるで数日間寝ていないかのように見えました。" },
            { word: "I wish I were good at singing.", meaning: "歌が上手ければいいのになあ。" },
            { word: "If I had known the truth, I would have told you.", meaning: "もし私が真実を知っていたら、あなたに話しただろう。" },
            { word: "He talks as if he knew everything.", meaning: "彼はまるで何でも知っているかのように話す。" },
            { word: "If you had been there, you would have enjoyed it.", meaning: "もしあなたがそこにいたら、楽しめたでしょう。" },
            { word: "I wish I could fly like a bird.", meaning: "鳥のように飛べたらいいのになあ。" },
            { word: "If I won a million dollars, I would travel the world.", meaning: "もし100万ドル当たったら、世界を旅するだろう。" },
            { word: "I wish I hadn't said that to her.", meaning: "彼女にそんなことを言わなければよかった。" },
            { word: "If I had a school backpack, I would donate it.", meaning: "もし私がランドセルを持っていれば、寄付するでしょう。" },
            { word: "He behaves as if nothing had happened.", meaning: "彼は何も起こらなかったかのように振る舞う。" },
            { word: "If it were not for the sun, nothing could live.", meaning: "もし太陽がなければ、何も生きられないだろう。" }
        ]
    }
};

// =========================================================
// 2. 構文テンプレートロジックは削除 (固定文のみ使用のため)
// =========================================================


// =========================================================
// 3. グローバルな状態管理とDOM要素
// =========================================================

const GAME_STATE = {
    currentMode: null, // 'normal' または 'instant'
    selectedSession: null, 
    selectedCourse: null,
    wordList: [],
    currentWordIndex: 0,
    score: 0,
    mistakeCount: 0,
    timer: 60, // 60秒からスタート
    timerInterval: null,
    isGameStarted: false,
    isGameOver: false,
    // 1単語内でのペナルティ適用を管理するフラグ
    currentWordMistakeFlag: false, 
};

const DURATION_PENALTY = 5; // ミスタイプ時のペナルティ秒数
const POINTS_PER_CHARACTER = 10; // 1文字あたりのスコア

// DOM要素の参照
const $ = id => document.getElementById(id);

const elements = {
    home: $('home-screen'),
    game: $('game-screen'),
    result: $('result-screen'),
    
    // Home elements
    courseSelectionTitle: $('course-selection-title'),
    courseSelectionContainer: $('course-selection-container'),
    selectedModeDisplay: $('selected-mode-display'),
    
    // Game elements
    currentModeDisplay: $('current-mode-display'),
    courseDisplay: $('current-course-display'),
    timer: $('timer'),
    score: $('score'),
    mistakeCount: $('mistake-count'),
    wordProgress: $('word-progress'),
    wordMeaning: $('word-meaning'),
    wordDisplay: $('word-display'),
    typingInput: $('typing-input'),
    feedbackMessage: $('feedback-message'),
    
    // Result elements
    finalScore: $('final-score'),
    completedWords: $('completed-words'),
    totalWords: $('total-words'),

    nounCourses: $('noun-courses'),
    verbCourses: $('verb-courses'),
    sentenceCourses: $('sentence-courses')
};


// =========================================================
// 4. UI画面の切り替え
// =========================================================

/**
 * 画面を切り替える
 * @param {('home'|'game'|'result')} screenId - 表示する画面ID
 */
function changeScreen(screenId) {
    elements.home.classList.add('hidden');
    elements.game.classList.add('hidden');
    elements.result.classList.add('hidden');
    
    if (screenId === 'home') {
        elements.home.classList.remove('hidden');
        // モード選択状態に応じてUIを調整
        if (GAME_STATE.currentMode) {
            showCourseSelection();
        } else {
            hideCourseSelection();
        }
    } else if (screenId === 'game') {
        elements.game.classList.remove('hidden');
    } else if (screenId === 'result') {
        elements.result.classList.remove('hidden');
        displayResult();
    }
}


/**
 * モードを選択し、コース選択UIを表示する
 * @param {('normal'|'instant')} mode - 選択されたモード
 */
function selectMode(mode) {
    GAME_STATE.currentMode = mode;
    const modeName = mode === 'normal' ? '通常モード' : '瞬間英作文モード';
    
    elements.selectedModeDisplay.textContent = modeName;
    elements.currentModeDisplay.textContent = modeName;

    // モード選択ボタンを非アクティブ化/アクティブ化
    $('btn-normal').classList.remove('bg-indigo-700');
    $('btn-instant').classList.remove('bg-purple-700');
    
    if (mode === 'normal') {
        $('btn-normal').classList.add('bg-indigo-700');
    } else {
        $('btn-instant').classList.add('bg-purple-700');
    }

    showCourseSelection();
}

function showCourseSelection() {
    elements.courseSelectionTitle.classList.remove('hidden');
    elements.courseSelectionContainer.classList.remove('hidden');
    renderHomeMenu();
}

function hideCourseSelection() {
    elements.courseSelectionTitle.classList.add('hidden');
    elements.courseSelectionContainer.classList.add('hidden');
}

/**
 * コース選択ボタンを作成するヘルパー関数
 */
function createCourseButton(session, courseName, buttonText) {
    const button = document.createElement('button');
    button.className = 'w-full px-4 py-3 text-left bg-indigo-100 text-indigo-800 rounded-lg font-semibold hover:bg-indigo-200 transition-colors shadow-sm';
    button.textContent = buttonText;
    button.onclick = () => {
        startGame(GAME_STATE.currentMode, session, courseName);
    };
    return button;
}

/**
 * ホームメニューのコース選択ボタンを生成する
 */
function renderHomeMenu() {
    elements.nounCourses.innerHTML = '';
    elements.verbCourses.innerHTML = '';
    elements.sentenceCourses.innerHTML = ''; // 英文コースセッションの初期化

    // 普通名詞・一般動詞セッションのレンダリング
    for (const session in WORD_DATA) {
        let targetElement;
        
        if (session === "普通名詞セッション") {
            targetElement = elements.nounCourses;
        } else if (session === "一般動詞セッション") {
            targetElement = elements.verbCourses;
        } else if (session === "英文コースセッション") {
            targetElement = elements.sentenceCourses;
        } else {
            continue;
        }

        for (const courseName in WORD_DATA[session]) {
            // パターンコース名が長いため、スタイルを調整できますが、今回はそのまま表示します。
            const button = createCourseButton(session, courseName, courseName);
            targetElement.appendChild(button);
        }
    }
}


// =========================================================
// 5. ゲームロジック
// =========================================================

/**
 * コースを選択し、ゲーム状態を初期化してゲームを開始する
 * @param {string} mode - 'normal' or 'instant'
 * @param {string} sessionName 
 * @param {string} courseName 
 */
function startGame(mode, sessionName, courseName) {
    // 固定文リストを取得
    let wordList = [];
    if (WORD_DATA[sessionName] && WORD_DATA[sessionName][courseName]) {
        // === 全てのコースは固定データを使用 ===
        // データをシャッフルして、ランダムな出題順にする
        wordList = [...WORD_DATA[sessionName][courseName]].sort(() => Math.random() - 0.5); 
    } else {
        console.error("Invalid course selection:", sessionName, courseName);
        return;
    }

    // ゲーム状態のリセット
    GAME_STATE.currentMode = mode;
    GAME_STATE.selectedSession = sessionName;
    GAME_STATE.selectedCourse = courseName;
    GAME_STATE.wordList = wordList;
    GAME_STATE.currentWordIndex = 0;
    GAME_STATE.score = 0;
    GAME_STATE.mistakeCount = 0;
    GAME_STATE.timer = 60;
    GAME_STATE.isGameStarted = false;
    GAME_STATE.isGameOver = false;
    GAME_STATE.currentWordMistakeFlag = false; 

    clearInterval(GAME_STATE.timerInterval);
    elements.typingInput.value = '';
    elements.typingInput.disabled = false; // 入力を有効化

    // UIの初期設定
    elements.currentModeDisplay.textContent = mode === 'normal' ? '通常モード' : '瞬間英作文モード';
    // コース表示名を調整
    const courseDisplayName = `${sessionName} / ${courseName}`;
    elements.courseDisplay.textContent = courseDisplayName;
    elements.timer.textContent = GAME_STATE.timer;
    elements.score.textContent = GAME_STATE.score;
    elements.mistakeCount.textContent = GAME_STATE.mistakeCount;
    elements.totalWords.textContent = GAME_STATE.wordList.length;

    // ゲーム開始
    elements.typingInput.focus();
    displayCurrentWord();
    changeScreen('game');

    // 最初の入力でゲームが開始するようにイベントリスナーを設定
    elements.typingInput.onkeydown = startOnFirstKeydown;
}


/**
 * 最初のキー入力でタイマーをスタートさせる
 */
function startOnFirstKeydown(event) {
    if (!GAME_STATE.isGameStarted && !GAME_STATE.isGameOver) {
        // アルファベットキーかスペースキー、記号などが押されたら開始
        if (event.key.length === 1 && event.key.match(/^[a-zA-Z\s,.'";:-]$/)) {
            GAME_STATE.isGameStarted = true;
            elements.typingInput.onkeydown = null; // イベントを解除
            startTimer();
        }
    }
}


/**
 * タイマーを開始する
 */
function startTimer() {
    GAME_STATE.timerInterval = setInterval(() => {
        if (GAME_STATE.timer <= 0) {
            clearInterval(GAME_STATE.timerInterval);
            gameOver();
            return;
        }
        GAME_STATE.timer--;
        elements.timer.textContent = GAME_STATE.timer;
    }, 1000);
}


/**
 * 現在の単語を画面に表示する
 */
function displayCurrentWord() {
    if (GAME_STATE.currentWordIndex >= GAME_STATE.wordList.length) {
        gameOver();
        return;
    }

    const currentWordData = GAME_STATE.wordList[GAME_STATE.currentWordIndex];
    
    // 新しい単語/文が始まったらペナルティフラグをリセット
    GAME_STATE.currentWordMistakeFlag = false; 

    // UIをリセット
    elements.typingInput.value = '';
    elements.typingInput.focus();
    elements.wordMeaning.textContent = currentWordData.meaning;
    elements.wordProgress.textContent = `${GAME_STATE.currentWordIndex} / ${GAME_STATE.wordList.length}`;
    elements.feedbackMessage.textContent = '';
    
    // モードに応じて単語の表示を初期化
    if (GAME_STATE.currentMode === 'normal') {
        // 通常モード: 最初の文字をハイライトして、残りの文字を表示
        elements.wordDisplay.innerHTML = `<span class="current-char">${currentWordData.word.charAt(0)}</span>${currentWordData.word.substring(1)}`;
    } else {
        // 瞬間英作文モード: 全てをブランクで表示 (最初の文字をハイライト)
        let blanks = '';
        for (let i = 0; i < currentWordData.word.length; i++) {
            if (i === 0) {
                // 最初の文字はブランクに見せるが、ハイライトする
                blanks += `<span class="current-char">${currentWordData.word[i] === ' ' ? '&nbsp;' : '_'}</span>`; 
            } else if (currentWordData.word[i] === ' ') {
                blanks += `<span class="blank-char">&nbsp;</span>`; // スペースはそのまま
            } else {
                blanks += `<span class="blank-char">_</span>`;
            }
        }
        elements.wordDisplay.innerHTML = `<p class="instant-mode-text">${blanks}</p>`;
    }
}


/**
 * ユーザーのキー入力を処理する
 */
elements.typingInput.addEventListener('input', () => {
    if (GAME_STATE.isGameOver || !GAME_STATE.isGameStarted) return;
    
    const currentWord = GAME_STATE.wordList[GAME_STATE.currentWordIndex].word;
    let typedText = elements.typingInput.value;
    let isMistake = false;

    // リアルタイムでの文字色ハイライトとミス判定
    let highlightedWord = '';
    
    for (let i = 0; i < currentWord.length; i++) {
        let char = currentWord[i];
        
        if (i < typedText.length) {
            if (char === typedText[i]) {
                // 正しい文字
                highlightedWord += `<span class="correct">${char}</span>`;
            } else {
                // 間違い検出
                if (GAME_STATE.currentMode === 'normal') {
                    // 通常モード: 間違った文字を赤くハイライト
                    highlightedWord += `<span class="incorrect">${char}</span>`;
                } else {
                    // 瞬間英作文モード: 間違った文字を赤くハイライト（フィードバックのため）
                    highlightedWord += `<span class="incorrect">${char}</span>`;
                }
                isMistake = true;
                break; // 最初の間違いでループを中断
            }
        } else if (i === typedText.length) {
            // 次に入力すべき文字 (現在カーソルがある位置)
            if (GAME_STATE.currentMode === 'normal') {
                highlightedWord += `<span class="current-char">${char}</span>`;
            } else {
                // 瞬間英作文モード: ブランク（_）で表示
                highlightedWord += `<span class="current-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        } else {
            // 未入力の文字
            if (GAME_STATE.currentMode === 'normal') {
                highlightedWord += char;
            } else {
                 // 瞬間英作文モード: ブランク（_）で表示
                highlightedWord += `<span class="blank-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        }
    }
    
    // 間違いが検出された場合、未入力部分の表示を調整
    if (isMistake && typedText.length < currentWord.length) {
        let remaining = currentWord.substring(typedText.length + 1); // 間違えた文字の次から
        
        for (let i = 0; i < remaining.length; i++) {
            let char = remaining[i];
            if (GAME_STATE.currentMode === 'normal') {
                 highlightedWord += char;
            } else {
                highlightedWord += `<span class="blank-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        }
    }


    // ハイライト表示の更新
    // 瞬間英作文モードでは、正しい入力中のみブランクを埋めるように見せる
    if (GAME_STATE.currentMode === 'instant' && !isMistake) {
        elements.wordDisplay.innerHTML = `<p class="instant-mode-text">${highlightedWord}</p>`;
    } else {
        elements.wordDisplay.innerHTML = highlightedWord;
    }


    if (isMistake) {
        // === ミスタイプ時のペナルティ処理 ===
        
        // 1単語内でまだペナルティを適用していない場合のみ実行
        if (!GAME_STATE.currentWordMistakeFlag) {
            GAME_STATE.mistakeCount++;
            elements.mistakeCount.textContent = GAME_STATE.mistakeCount;
            GAME_STATE.timer = Math.max(0, GAME_STATE.timer - DURATION_PENALTY); // 時間をマイナス5秒
            elements.timer.textContent = GAME_STATE.timer;
            elements.feedbackMessage.innerHTML = `<span class="text-red-500 font-bold">ミス！ -${DURATION_PENALTY}秒ペナルティ (修正して続行)</span>`;
            
            // ペナルティフラグを立てる
            GAME_STATE.currentWordMistakeFlag = true;

            if (GAME_STATE.timer <= 0) {
                clearInterval(GAME_STATE.timerInterval);
                gameOver();
            }
        }
        
    } else {
        elements.feedbackMessage.textContent = '';
        
        if (typedText.length === currentWord.length) {
            // === 単語完了時の処理 ===
            if (typedText === currentWord) {
                GAME_STATE.score += currentWord.length * POINTS_PER_CHARACTER;
                elements.score.textContent = GAME_STATE.score;
                elements.feedbackMessage.innerHTML = `<span class="text-green-500 font-bold">PERFECT! +${currentWord.length * POINTS_PER_CHARACTER}ポイント</span>`;
                
                // 次の単語へ
                GAME_STATE.currentWordIndex++;
                
                // わずかな遅延後、次の単語を表示
                setTimeout(() => {
                    displayCurrentWord();
                }, 500);
            }
        }
    }
});


/**
 * ゲームオーバー処理
 */
function gameOver() {
    if (GAME_STATE.isGameOver) return;
    
    GAME_STATE.isGameOver = true;
    GAME_STATE.isGameStarted = false;
    clearInterval(GAME_STATE.timerInterval);
    elements.typingInput.disabled = true;

    changeScreen('result');
}

/**
 * 結果画面の表示を更新する
 */
function displayResult() {
    elements.finalScore.textContent = GAME_STATE.score;
    elements.completedWords.textContent = GAME_STATE.currentWordIndex;
    elements.totalWords.textContent = GAME_STATE.wordList.length;
}


// =========================================================
// 6. 初期化
// =========================================================

// ページロード時にホーム画面を表示
window.onload = function() {
    // 初期状態ではモード選択のみ表示
    hideCourseSelection();
    changeScreen('home');
};

</script>
