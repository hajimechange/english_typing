<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Typing Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントとレスポンシブ対応 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        /* 入力エリアのカスタムスタイル */
        #typing-input {
            font-size: 1.5rem;
            line-height: 2rem;
            letter-spacing: 0.025em;
            padding: 1rem 1.25rem;
            border: 2px solid #ccc;
            transition: border-color 0.3s, box-shadow 0.3s;
            outline: none;
            caret-color: #3b82f6;
            font-family: monospace; /* タイピングに適したフォント */
        }
        #typing-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        /* 単語/英文表示エリア */
        #word-display, #word-meaning {
            min-height: 50px;
            padding: 1rem 0;
            text-align: center;
            margin-bottom: 1rem;
        }
        #word-meaning {
            /* 日本語を大きく表示 */
            font-size: 2.25rem; /* text-4xl */
            line-height: 2.5rem;
            font-weight: 800; /* font-extrabold */
            color: #1f2937; /* Gray-800 */
        }
        #word-display {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 500;
            color: #4b5563; /* Gray-600 */
            letter-spacing: 0.05em;
        }
        /* タイピングのフィードバック */
        .correct { color: #10b981; } /* エメラルドグリーン */
        .incorrect { color: #dc2626; } /* 赤 */
        .current { 
            border-bottom: 3px solid #f97316; /* オレンジの下線 */
            font-weight: 700;
            color: #1f2937;
        }
        /* 瞬間英作文モードの非表示 */
        .hidden-spell {
            color: transparent;
        }
        .instant-correct {
             color: #10b981; /* 瞬間英作文モードで正しく打たれた文字 */
             text-shadow: none;
        }
        .instant-current {
            border-bottom: 3px solid #f97316;
            color: #1f2937;
        }
    </style>
</head>
<body>

<div id="game-container" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center mb-8">English Typing Game</h1>

    <!-- 1. モード選択画面 -->
    <div id="mode-selection" class="text-center">
        <h2 class="text-2xl font-semibold mb-6 text-indigo-600">モードを選択してください</h2>
        <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-8">
            <button onclick="selectMode('normal')" class="p-6 bg-blue-100 border-2 border-blue-500 text-blue-800 font-bold rounded-xl shadow-lg hover:bg-blue-200 transition duration-150 transform hover:scale-105">
                通常モード (スペル表示)
            </button>
            <button onclick="selectMode('instant')" class="p-6 bg-purple-100 border-2 border-purple-500 text-purple-800 font-bold rounded-xl shadow-lg hover:bg-purple-200 transition duration-150 transform hover:scale-105">
                瞬間英作文モード (スペル非表示)
            </button>
        </div>
    </div>

    <!-- 2. ホームメニュー (コース選択) -->
    <div id="home-menu" class="hidden text-center">
        <h2 id="mode-title" class="text-2xl font-semibold mb-6 text-indigo-600"></h2>
        <div id="session-buttons" class="grid grid-cols-1 sm:grid-cols-3 gap-6">
            <!-- セッションボタンがJSによって挿入されます -->
        </div>
    </div>

    <!-- 3. コース選択メニュー -->
    <div id="course-menu" class="hidden text-center">
        <h2 id="session-title" class="text-2xl font-semibold mb-6 text-indigo-600"></h2>
        <div id="course-buttons" class="grid grid-cols-2 md:grid-cols-3 gap-4">
            <!-- コースボタンがJSによって挿入されます -->
        </div>
        <button onclick="showHomeMenu()" class="mt-8 px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition">
            セッション選択に戻る
        </button>
    </div>

    <!-- 4. ゲームプレイエリア -->
    <div id="game-play" class="hidden">
        <div class="flex justify-between items-center mb-6 p-4 bg-indigo-50 rounded-lg shadow-inner">
            <div class="text-center">
                <div class="text-xs text-indigo-600 font-semibold uppercase">残り時間</div>
                <div id="timer" class="text-2xl md:text-3xl font-extrabold text-indigo-800">60</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-indigo-600 font-semibold uppercase">正解単語数</div>
                <div id="score" class="text-2xl md:text-3xl font-extrabold text-indigo-800">0</div>
            </div>
            <div class="text-center">
                <div class="text-xs text-indigo-600 font-semibold uppercase">コース</div>
                <div id="current-course" class="text-base font-semibold text-gray-600">--</div>
            </div>
        </div>

        <!-- タイピング表示エリア -->
        <div id="word-meaning" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-gray-800">
            <!-- 日本語の意味が表示される -->
        </div>
        
        <div id="word-display" class="bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg text-gray-700 select-none leading-relaxed">
            <!-- 英単語/英文が表示される -->
            <span class="text-gray-400">「スタート」ボタンを押して開始してください。</span>
        </div>

        <!-- 入力エリア -->
        <input 
            type="text" 
            id="typing-input" 
            placeholder="ここに英単語/英文を入力します..." 
            autocomplete="off" 
            autocapitalize="off"
            class="w-full rounded-lg text-gray-700 mb-6 mt-4"
            disabled
        />

        <!-- コントロールボタン -->
        <div class="flex justify-center space-x-4">
            <button id="next-button" class="px-6 py-2 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105" disabled>
                次の問題へ
            </button>
            <button id="end-button" class="px-6 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700 transition duration-150 transform hover:scale-105">
                終了
            </button>
        </div>
    </div>

    <!-- ゲーム終了メッセージモーダル（カスタム） -->
    <div id="end-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center transform scale-100 transition-all duration-300 ease-out">
            <h2 class="text-3xl md:text-4xl font-extrabold text-indigo-600 mb-4">結果発表！</h2>
            <p class="text-lg text-gray-700 mb-2">タイプ数: <span id="final-total-typed" class="font-bold">0</span></p>
            <p class="text-lg text-gray-700 mb-6">正解単語数:</p>
            <p id="final-score" class="text-6xl font-black text-blue-800 mb-8">0</p>
            <button onclick="showHomeMenu()" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                ホームに戻る
            </button>
        </div>
    </div>

    <!-- メッセージモーダル -->
    <div id="message-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <p id="modal-message" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button onclick="hideMessageModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                OK
            </button>
        </div>
    </div>
</div>

<script>
    // --- 意味順ドリルデータ ---
    // 添付された最新のCSVファイル「意味順ドリルリスト.xlsx - Sheet1.csv」から抽出した、全9パターン180問の固定問題
    const WORD_DATA = {
        "普通名詞セッション": {
            "Level 1 (初級)": [
                { en: "dog", ja: "犬" }, { en: "cat", ja: "猫" }, { en: "apple", ja: "りんご" }, { en: "book", ja: "本" }, { en: "car", ja: "車" },
                { en: "house", ja: "家" }, { en: "tree", ja: "木" }, { en: "sun", ja: "太陽" }, { en: "moon", ja: "月" }, { en: "star", ja: "星" },
                { en: "pen", ja: "ペン" }, { en: "cup", ja: "カップ" }, { en: "desk", ja: "机" }, { en: "chair", ja: "椅子" }, { en: "door", ja: "ドア" },
                { en: "girl", ja: "少女" }, { en: "boy", ja: "少年" }, { en: "man", ja: "男性" }, { en: "woman", ja: "女性" }, { en: "flower", ja: "花" }
            ],
            "Level 2 (中級)": [
                { en: "computer", ja: "コンピューター" }, { en: "telephone", ja: "電話" }, { en: "umbrella", ja: "傘" }, { en: "mountain", ja: "山" }, { en: "river", ja: "川" },
                { en: "ocean", ja: "海" }, { en: "country", ja: "国" }, { en: "city", ja: "都市" }, { en: "street", ja: "通り" }, { en: "hospital", ja: "病院" },
                { en: "market", ja: "市場" }, { en: "museum", ja: "美術館" }, { en: "camera", ja: "カメラ" }, { en: "ticket", ja: "チケット" }, { en: "clothes", ja: "服" },
                { en: "friend", ja: "友達" }, { en: "family", ja: "家族" }, { en: "office", ja: "オフィス" }, { en: "garden", ja: "庭" }, { en: "music", ja: "音楽" }
            ]
        },
        "一般動詞セッション": {
            "Level 1 (現在形)": [
                { en: "run", ja: "走る" }, { en: "walk", ja: "歩く" }, { en: "eat", ja: "食べる" }, { en: "drink", ja: "飲む" }, { en: "sleep", ja: "眠る" },
                { en: "read", ja: "読む" }, { en: "write", ja: "書く" }, { en: "speak", ja: "話す" }, { en: "listen", ja: "聞く" }, { en: "watch", ja: "見る" },
                { en: "play", ja: "遊ぶ" }, { en: "study", ja: "勉強する" }, { en: "work", ja: "働く" }, { en: "live", ja: "住む" }, { en: "travel", ja: "旅行する" },
                { en: "start", ja: "始める" }, { en: "finish", ja: "終える" }, { en: "open", ja: "開ける" }, { en: "close", ja: "閉める" }, { en: "know", ja: "知っている" }
            ],
            "Level 2 (過去形)": [
                { en: "ran", ja: "走った" }, { en: "walked", ja: "歩いた" }, { en: "ate", ja: "食べた" }, { en: "drank", ja: "飲んだ" }, { en: "slept", ja: "眠った" },
                { en: "read", ja: "読んだ" }, { en: "wrote", ja: "書いた" }, { en: "spoke", ja: "話した" }, { en: "listened", ja: "聞いた" }, { en: "watched", ja: "見た" },
                { en: "played", ja: "遊んだ" }, { en: "studied", ja: "勉強した" }, { en: "worked", ja: "働いた" }, { en: "lived", ja: "住んだ" }, { en: "traveled", ja: "旅行した" },
                { en: "started", ja: "始めた" }, { en: "finished", ja: "終えた" }, { en: "opened", ja: "開けた" }, { en: "closed", ja: "閉めた" }, { en: "knew", ja: "知っていた" }
            ]
        },
        "英文コースセッション": {
            "パターン1：「誰が(S)」「する(V)」（S + V / S + V + C）": [
                { en: "I am Edward Trout.", ja: "私はエドワード・トラウトです。" }, { en: "Are you an anime fan?", ja: "あなたはアニメのファンですか。" },
                { en: "Be brave.", ja: "勇気を出して。" }, { en: "Don't worry.", ja: "心配しないで。" }, { en: "The children look happy.", ja: "子供たちは幸せそうに見えます。" },
                { en: "Talking with him was fun.", ja: "彼と話すことは楽しかったです。" }, { en: "My sister sings well.", ja: "私の姉は歌が上手です。" },
                { en: "The sky is blue.", ja: "空は青いです。" }, { en: "She became a teacher.", ja: "彼女は先生になりました。" }, { en: "We work hard.", ja: "私たちは一生懸命働きます。" },
                { en: "The door opened.", ja: "ドアが開きました。" }, { en: "The food tastes salty.", ja: "その食べ物は塩辛い味がします。" }, { en: "Everyone smiled.", ja: "みんなが微笑みました。" },
                { en: "He lives in Japan.", ja: "彼は日本に住んでいます。" }, { en: "I came back at 6 p.m.", ja: "私は午後6時に帰ってきました。" },
                { en: "She waited for him.", ja: "彼女は彼を待ちました。" }, { en: "He looks happy.", ja: "彼は幸せそうに見えます。" },
                { en: "I feel good.", ja: "私は気分がいいです。" }, { en: "He is sad.", ja: "彼は悲しいです。" }, { en: "I walked fast.", ja: "私は速く歩きました。" }
            ],
            "パターン2：「誰が(S)」「する(V)」「何を(O)」（S + V + O）": [
                { en: "I like Japanese sweets.", ja: "私は日本の甘い菓子が好きです。" }, { en: "Do you like rugby?", ja: "あなたはラグビーが好きですか。" },
                { en: "I do not play rugby.", ja: "私はラグビーをしません。" }, { en: "I cannot make shumai.", ja: "私はシュウマイを作ることができません。" },
                { en: "Can you read hiragana?", ja: "あなたはひらがなを読むことができますか。" }, { en: "You should not eat this much.", ja: "あなたはこんなにたくさん食べるべきではありません。" },
                { en: "I know his name.", ja: "私は彼の名前を知っています。" }, { en: "She wants a new dress.", ja: "彼女は新しいドレスを欲しがっています。" },
                { en: "He has a big dog.", ja: "彼は大きな犬を飼っています。" }, { en: "We saw him yesterday.", ja: "私たちは昨日彼に会いました。" },
                { en: "I want to eat pizza.", ja: "私はピザを食べたいです。" }, { en: "He stopped smoking.", ja: "彼は喫煙をやめました。" },
                { en: "I enjoyed reading the book.", ja: "私はその本を読むことを楽しみました。" }, { en: "She finished doing her homework.", ja: "彼女は宿題を終えました。" },
                { en: "I decided to go home.", ja: "私は家に帰ることに決めました。" }, { en: "They like playing tennis.", ja: "彼らはテニスをすることが好きです。" },
                { en: "I want to know the truth.", ja: "私は真実を知りたいです。" }, { en: "She needs to buy some food.", ja: "彼女は食べ物を買う必要があります。" },
                { en: "We must study hard.", ja: "私たちは一生懸命勉強しなければなりません。" }, { en: "You do not have to clean the room.", ja: "あなたは部屋を掃除する必要はありません。" }
            ],
            "パターン3：「誰が(S)」「する(V)」「誰に(O)」「何を(O)」（S + V + O + O）": [
                { en: "They gave us some drinks.", ja: "彼らは私たちに飲み物をいくらかくれました。" }, { en: "My father bought me a new camera.", ja: "私の父は私に新しいカメラを買ってくれました。" },
                { en: "Can you show me your photo?", ja: "あなたの写真を見せてくれませんか。" }, { en: "She taught us English.", ja: "彼女は私たちに英語を教えてくれました。" },
                { en: "I will make him a nice dinner.", ja: "私は彼に素敵な夕食を作ってあげるつもりです。" }, { en: "Tell me your name.", ja: "あなたの名前を私に教えてください。" },
                { en: "Please pass me the salt.", ja: "私に塩を取ってください。" }, { en: "I wrote her a letter.", ja: "私は彼女に手紙を書きました。" },
                { en: "He sent me an email.", ja: "彼は私にメールを送りました。" }, { en: "She brought him a cup of coffee.", ja: "彼女は彼にコーヒーを持ってきてくれました。" },
                { en: "I bought him a ticket to the concert.", ja: "私は彼にコンサートのチケットを買ってあげました。" }, { en: "We sang them a song.", ja: "私たちは彼らに歌を歌いました。" },
                { en: "He showed us how to cook.", ja: "彼は私たちに料理の仕方を教えてくれました。" }, { en: "They made her a chair.", ja: "彼らは彼女に椅子を作ってあげました。" },
                { en: "The book taught me many things.", ja: "その本は私に多くのことを教えてくれました。" }, { en: "She gave me a beautiful flower.", ja: "彼女は私に美しい花をくれました。" },
                { en: "Can you lend me your umbrella?", ja: "私にあなたの傘を貸してくれませんか。" }, { en: "He found her a job.", ja: "彼は彼女に仕事を見つけてあげました。" },
                { en: "I offered him a drink.", ja: "私は彼に飲み物を勧めました。" }, { en: "They asked me a difficult question.", ja: "彼らは私に難しい質問をしました。" }
            ],
            "パターン4：「誰が(S)」「する(V)」「何を(O)」「どう(C/A)」（S + V + O + C / S + V + O + A）": [
                { en: "I found the box empty.", ja: "私はその箱が空だとわかりました。" }, { en: "We call this festival Tanabata.", ja: "私たちはこの祭りを七夕と呼びます。" },
                { en: "I want you to come here.", ja: "私はあなたにここに来てほしいです。" }, { en: "She told me to wait.", ja: "彼女は私に待つように言いました。" },
                { en: "He made me happy.", ja: "彼は私を幸せにしました。" }, { en: "They kept the secret safe.", ja: "彼らは秘密を安全に保ちました。" },
                { en: "I think him a genius.", ja: "私は彼を天才だと思います。" }, { en: "We consider her a good leader.", ja: "私たちは彼女を良いリーダーだと考えています。" },
                { en: "I saw him running.", ja: "私は彼が走っているのを見ました。" }, { en: "She heard him sing.", ja: "彼女は彼が歌うのを聞きました。" },
                { en: "They named the baby Hana.", ja: "彼らはその赤ちゃんにハナと名付けました。" }, { en: "I will leave the window open.", ja: "私は窓を開けたままにしておくつもりです。" },
                { en: "He let me use his phone.", ja: "彼は私に彼の電話を使わせてくれました。" }, { en: "I had my hair cut.", ja: "私は髪を切ってもらいました。" },
                { en: "The police caught the thief stealing.", ja: "警察はその泥棒が盗んでいるところを捕まえました。" }, { en: "She painted the wall red.", ja: "彼女は壁を赤く塗りました。" },
                { en: "We believe him honest.", ja: "私たちは彼が正直だと信じています。" }, { en: "I found the key on the floor.", ja: "私は床で鍵を見つけました。" },
                { en: "He put his hand on my shoulder.", ja: "彼は私の肩に手を置きました。" }, { en: "We elected him president.", ja: "私たちは彼を大統領に選びました。" }
            ],
            "パターン5：「誰が(S)」「する(V)」「何を(O)」（動詞の後ろにto不定詞・動名詞）": [
                { en: "I decided to study abroad.", ja: "私は留学することを決めました。" }, { en: "She promised to help me.", ja: "彼女は私を助けることを約束しました。" },
                { en: "I finished writing a report.", ja: "私はレポートを書き終えました。" }, { en: "He enjoys playing the guitar.", ja: "彼はギターを弾くことを楽しみます。" },
                { en: "I want to know where he lives.", ja: "私は彼がどこに住んでいるのか知りたいです。" }, { en: "I don't know what to say.", ja: "何を言うべきかわかりません。" },
                { en: "He suddenly began to sing.", ja: "彼は突然歌い始めました。" }, { en: "I stopped eating sweets.", ja: "私は甘いものを食べるのをやめました。" },
                { en: "Remember to lock the door.", ja: "ドアに鍵をかけることを覚えておきなさい。" }, { en: "I remember meeting him.", ja: "私は彼に会ったことを覚えています。" },
                { en: "I regret saying that.", ja: "私はそう言ったことを後悔しています。" }, { en: "I tried to open the door.", ja: "私はドアを開けようとしました。" },
                { en: "They hope to visit Kyoto.", ja: "彼らは京都を訪れることを望んでいます。" }, { en: "I learned how to make bread.", ja: "私はパンの作り方を学びました。" },
                { en: "She started crying.", ja: "彼女は泣き始めました。" }, { en: "Avoid driving fast.", ja: "速く運転することは避けなさい。" },
                { en: "We need to leave now.", ja: "私たちは今出発する必要があります。" }, { en: "I don't mind waiting.", ja: "私は待つのを気にしません。" },
                { en: "He suggested going to the park.", ja: "彼は公園に行くことを提案しました。" }, { en: "I prefer reading books.", ja: "私は本を読むことを好みます。" }
            ],
            "パターン6：「誰が(S)」「する(V)」 (補語・副詞の後に to V / that節)": [
                { en: "She is happy to hear that.", ja: "彼女はそれを聞いて嬉しいです。" }, { en: "I am sure that he will come.", ja: "彼が来ることを私は確信しています。" },
                { en: "It is important to study English.", ja: "英語を勉強することは重要です。" }, { en: "I am sorry to bother you.", ja: "お邪魔してすみません。" },
                { en: "It is easy for him to run fast.", ja: "彼が速く走ることは簡単です。" }, { en: "I was surprised to see her there.", ja: "私は彼女がそこにいるのを見て驚きました。" },
                { en: "She seems to be rich.", ja: "彼女は裕福なようです。" }, { en: "It is necessary that we act now.", ja: "私たちが今行動することが必要です。" },
                { en: "I hope that you are well.", ja: "あなたが元気であることを望んでいます。" }, { en: "He spoke loud enough to be heard.", ja: "彼は聞こえるほど大きな声で話しました。" },
                { en: "The news made me happy.", ja: "その知らせは私を幸せにしました。" }, { en: "I found it difficult to finish the task.", ja: "私はその仕事を終えるのは難しいとわかりました。" },
                { en: "She decided that she would leave.", ja: "彼女は出発することを決心しました。" }, { en: "I believe that she is right.", ja: "私は彼女が正しいと信じています。" },
                { en: "It is true that he is famous.", ja: "彼が有名だというのは本当です。" }, { en: "I heard that they moved.", ja: "彼らが引っ越したと聞きました。" },
                { en: "She thought that I was wrong.", ja: "彼女は私が間違っていると思いました。" }, { en: "I found that the door was open.", ja: "私はドアが開いていることに気づきました。" },
                { en: "It is time to go home.", ja: "家に帰る時間です。" }, { en: "She is too tired to walk.", ja: "彼女は疲れすぎて歩けません。" }
            ],
            "パターン7：「誰が(S)」「する(V)」（時制・完了形）": [
                { en: "I have known him for ten years.", ja: "私は彼を10年間知っています。" }, { en: "Have you ever been to Canada?", ja: "あなたは今までにカナダへ行ったことがありますか。" },
                { en: "She has just finished her homework.", ja: "彼女はちょうど宿題を終えたところです。" }, { en: "He has lived here since 2010.", ja: "彼は2010年からここに住んでいます。" },
                { en: "When did you buy this car?", ja: "あなたはいつこの車を買いましたか。" }, { en: "I was reading a book when he called.", ja: "彼が電話してきたとき、私は本を読んでいました。" },
                { en: "I am going to visit her tomorrow.", ja: "私は明日、彼女を訪ねるつもりです。" }, { en: "He will be back soon.", ja: "彼はすぐに戻ってくるでしょう。" },
                { en: "She has been studying all day.", ja: "彼女は一日中ずっと勉強しています。" }, { en: "By next week, I will have finished the project.", ja: "来週までに、私はそのプロジェクトを終えているでしょう。" },
                { en: "She had already left when I arrived.", ja: "私が到着したとき、彼女はすでに去っていました。" }, { en: "I wish I had met him sooner.", ja: "もっと早く彼に会えていたらよかったのに。" },
                { en: "I think I will go.", ja: "私は行くだろうと思います。" }, { en: "He looks as if he has seen a ghost.", ja: "彼はまるで幽霊を見たかのように見えます。" },
                { en: "The train had already left.", ja: "その電車はすでに出発していました。" }, { en: "I will call you when I arrive.", ja: "着いたら電話します。" },
                { en: "She is always complaining.", ja: "彼女はいつも文句ばかり言っています。" }, { en: "We are watching a movie now.", ja: "私たちは今、映画を見ています。" },
                { en: "He used to live here.", ja: "彼は以前ここに住んでいました。" }, { en: "I would often visit my grandmother.", ja: "私はよく祖母を訪ねたものでした。" }
            ],
            "パターン8：「誰が(S)」「される(V)」（受動態）": [
                { en: "This song is loved by many people.", ja: "この歌は多くの人々に愛されています。" }, { en: "The bridge was built last year.", ja: "その橋は昨年建てられました。" },
                { en: "English is spoken in many countries.", ja: "英語は多くの国で話されています。" }, { en: "Is this food made in Japan?", ja: "この食べ物は日本で作られていますか。" },
                { en: "The room will be cleaned tomorrow.", ja: "その部屋は明日掃除されるでしょう。" }, { en: "I was surprised at the news.", ja: "私はそのニュースに驚きました。" },
                { en: "He was killed in the war.", ja: "彼は戦争で亡くなりました。" }, { en: "The work must be finished by noon.", ja: "その仕事は正午までに終えられなければなりません。" },
                { en: "I was caught in a heavy rain.", ja: "私は激しい雨に遭いました。" }, { en: "He is known to everyone.", ja: "彼は皆に知られています。" },
                { en: "The window was broken by the wind.", ja: "その窓は風によって割られました。" }, { en: "I was invited to her party.", ja: "私は彼女のパーティーに招待されました。" },
                { en: "What is this tool used for?", ja: "この道具は何に使われていますか。" }, { en: "The old painting was found.", ja: "その古い絵画は見つけられました。" },
                { en: "She was given a beautiful ring.", ja: "彼女は美しい指輪を贈られました。" }, { en: "The problem was discussed.", ja: "その問題は議論されました。" },
                { en: "He is satisfied with his new job.", ja: "彼は新しい仕事に満足しています。" }, { en: "The stadium is surrounded by trees.", ja: "そのスタジアムは木々に囲まれています。" },
                { en: "The rumor is believed to be true.", ja: "その噂は本当だと信じられています。" }, { en: "I was disappointed with the result.", ja: "私はその結果にがっかりしました。" }
            ],
            "パターン9：「誰が(S)」「する(V)」（関係代名詞・分詞・比較・仮定法）": [
                { en: "This is a pen which was given by him.", ja: "これは彼にもらったペンです。" }, { en: "He is a man who helped me.", ja: "彼は私を助けてくれた人です。" },
                { en: "The book that I read was interesting.", ja: "私が読んだその本は面白かったです。" }, { en: "I have a friend whose father is a doctor.", ja: "私には父親が医者である友達がいます。" },
                { en: "The boy running there is my brother.", ja: "あそこで走っている少年は私の弟です。" }, { en: "I found a coin dropped on the street.", ja: "私は通りに落ちているコインを見つけました。" },
                { en: "She is taller than I am.", ja: "彼女は私よりも背が高いです。" }, { en: "This is the most popular song.", ja: "これは最も人気のある歌です。" },
                { en: "If I were a bird, I would fly to you.", ja: "もし私が鳥なら、あなたのもとへ飛んでいくのに。" }, { en: "I wish I knew the answer.", ja: "その答えを知っていればいいのになあ。" },
                { en: "The girl standing by the window is my sister.", ja: "窓のそばに立っている少女は私の妹です。" }, { en: "This is the city where I was born.", ja: "ここは私が生まれた街です。" },
                { en: "The time when I met her was five years ago.", ja: "私が彼女に会ったのは5年前です。" }, { en: "This computer is more expensive than that one.", ja: "このコンピューターはあれよりも高価です。" },
                { en: "He is as strong as his father.", ja: "彼は彼の父と同じくらい強いです。" }, { en: "I have nothing to say.", ja: "私には言うべきことが何もありません。" },
                { en: "This is the best movie I have ever seen.", ja: "これは私が今までに見た中で最高の映画です。" }, { en: "I like summer the most.", ja: "私は夏が一番好きです。" },
                { en: "If I had enough money, I could buy the car.", ja: "もし私にお金が十分にあれば、その車を買うことができるのに。" }, { en: "He talked as if he knew everything.", ja: "彼はまるで全てを知っているかのように話しました。" }
            ]
        }
    };


    // --- グローバル変数とDOM要素 ---
    const elements = {
        modeSelection: document.getElementById('mode-selection'),
        homeMenu: document.getElementById('home-menu'),
        courseMenu: document.getElementById('course-menu'),
        gamePlay: document.getElementById('game-play'),
        modeTitle: document.getElementById('mode-title'),
        sessionButtons: document.getElementById('session-buttons'),
        courseButtons: document.getElementById('course-buttons'),
        sessionTitle: document.getElementById('session-title'),
        wordDisplay: document.getElementById('word-display'),
        wordMeaning: document.getElementById('word-meaning'),
        typingInput: document.getElementById('typing-input'),
        timer: document.getElementById('timer'),
        score: document.getElementById('score'),
        currentCourse: document.getElementById('current-course'),
        nextButton: document.getElementById('next-button'),
        endButton: document.getElementById('end-button'),
        endModal: document.getElementById('end-modal'),
        finalScore: document.getElementById('final-score'),
        finalTotalTyped: document.getElementById('final-total-typed'),
        messageModal: document.getElementById('message-modal'),
        modalMessage: document.getElementById('modal-message')
    };

    let game = {
        mode: null,          // 'normal' or 'instant'
        sessionName: null,   // "普通名詞セッション" など
        courseName: null,    // "Level 1 (初級)" など
        data: [],            // 現在のコースの問題リスト
        currentProblemIndex: 0,
        currentWord: '',     // タイピング対象の英文
        currentMeaning: '',  // 和訳
        currentCharIndex: 0,
        score: 0,
        totalTyped: 0,       // 総タイプ数
        timeLeft: 60,
        timerInterval: null,
        isGameRunning: false,
        hasMistyped: false,   // 現在の問題で既にペナルティを受けたか
    };


    // --- ユーティリティ関数 ---

    /**
     * メッセージモーダルを表示します。
     * @param {string} message - 表示するメッセージ
     */
    function showMessageModal(message) {
        elements.modalMessage.textContent = message;
        elements.messageModal.classList.remove('hidden');
        elements.messageModal.classList.add('flex');
    }

    /**
     * メッセージモーダルを非表示にします。
     */
    function hideMessageModal() {
        elements.messageModal.classList.remove('flex');
        elements.messageModal.classList.add('hidden');
    }

    /**
     * 配列をシャッフルします (Fisher-Yatesアルゴリズム)。
     * @param {Array<any>} array - シャッフルする配列
     * @returns {Array<any>} シャッフルされた配列
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }


    // --- UI切り替え ---

    /**
     * 全ての画面を非表示にします。
     */
    function hideAllScreens() {
        Object.values(elements).forEach(el => {
            if (el.id && ['mode-selection', 'home-menu', 'course-menu', 'game-play'].includes(el.id)) {
                el.classList.add('hidden');
            }
        });
    }

    /**
     * モード選択画面を表示します。
     */
    function showModeSelection() {
        hideAllScreens();
        elements.modeSelection.classList.remove('hidden');
        game.isGameRunning = false;
        if (game.timerInterval) clearInterval(game.timerInterval);
    }

    /**
     * ホームメニュー（セッション選択）を表示します。
     */
    function showHomeMenu() {
        hideAllScreens();
        elements.homeMenu.classList.remove('hidden');
        elements.modeTitle.textContent = game.mode === 'normal' ? "通常モード (スペル表示)" : "瞬間英作文モード (スペル非表示)";
        renderSessionButtons();
        
        // モーダルを閉じる
        elements.endModal.classList.add('hidden');
        elements.endModal.classList.remove('flex');
    }

    /**
     * コース選択メニューを表示します。
     */
    function showCourseMenu(sessionName) {
        hideAllScreens();
        elements.courseMenu.classList.remove('hidden');
        game.sessionName = sessionName;
        elements.sessionTitle.textContent = sessionName;
        renderCourseButtons(sessionName);
    }

    /**
     * ゲームプレイ画面を表示します。
     */
    function showGamePlay() {
        hideAllScreens();
        elements.gamePlay.classList.remove('hidden');
        elements.typingInput.focus();
    }


    // --- メインロジック ---

    /**
     * モードを選択し、ホームメニューへ移行します。
     * @param {string} mode - 'normal' または 'instant'
     */
    window.selectMode = function(mode) {
        game.mode = mode;
        showHomeMenu();
    };

    /**
     * セッションボタンをレンダリングします。
     */
    function renderSessionButtons() {
        elements.sessionButtons.innerHTML = '';
        Object.keys(WORD_DATA).forEach(sessionName => {
            const button = document.createElement('button');
            button.className = 'p-6 bg-green-100 border-2 border-green-500 text-green-800 font-bold rounded-xl shadow-lg hover:bg-green-200 transition duration-150 transform hover:scale-105';
            button.textContent = sessionName;
            button.onclick = () => showCourseMenu(sessionName);
            elements.sessionButtons.appendChild(button);
        });
    }

    /**
     * コースボタンをレンダリングします。
     * @param {string} sessionName - 現在のセッション名
     */
    function renderCourseButtons(sessionName) {
        elements.courseButtons.innerHTML = '';
        const courses = WORD_DATA[sessionName];
        Object.keys(courses).forEach(courseName => {
            const button = document.createElement('button');
            button.className = 'p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 font-semibold rounded-lg hover:bg-yellow-200 transition duration-150 transform hover:scale-100';
            button.textContent = courseName;
            button.onclick = () => startGame(courseName);
            elements.courseButtons.appendChild(button);
        });
    }

    /**
     * ゲームを開始します。
     * @param {string} courseName - 現在のコース名
     */
    function startGame(courseName) {
        game.courseName = courseName;
        const rawData = WORD_DATA[game.sessionName][courseName];
        
        // データをシャッフルして、ゲームデータとして格納
        game.data = shuffleArray([...rawData]); 

        game.currentProblemIndex = 0;
        game.score = 0;
        game.totalTyped = 0;
        game.timeLeft = 60;
        game.isGameRunning = true;
        
        // UI初期化
        elements.score.textContent = game.score;
        elements.timer.textContent = game.timeLeft;
        elements.currentCourse.textContent = courseName;
        elements.typingInput.value = '';
        elements.typingInput.disabled = false;
        elements.nextButton.disabled = true;

        showGamePlay();
        loadNextProblem();
        startTimer();
        elements.typingInput.focus();
    }

    /**
     * タイマーを開始します。
     */
    function startTimer() {
        if (game.timerInterval) clearInterval(game.timerInterval);

        game.timerInterval = setInterval(() => {
            if (!game.isGameRunning) {
                clearInterval(game.timerInterval);
                return;
            }
            
            game.timeLeft--;
            elements.timer.textContent = game.timeLeft;

            if (game.timeLeft <= 10) {
                elements.timer.classList.add('text-red-600', 'animate-pulse');
            } else {
                elements.timer.classList.remove('text-red-600', 'animate-pulse');
            }

            if (game.timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    }

    /**
     * ゲームを終了し、結果を表示します。
     */
    function endGame() {
        game.isGameRunning = false;
        clearInterval(game.timerInterval);
        elements.typingInput.disabled = true;
        elements.nextButton.disabled = true;

        elements.finalScore.textContent = game.score;
        elements.finalTotalTyped.textContent = game.totalTyped;
        elements.endModal.classList.add('flex');
        elements.endModal.classList.remove('hidden');
    }

    /**
     * 次の問題をロードし、UIを更新します。
     */
    function loadNextProblem() {
        if (game.currentProblemIndex >= game.data.length) {
            // 全問終了
            showMessageModal("全問終了しました！");
            endGame();
            return;
        }

        const problem = game.data[game.currentProblemIndex];
        
        game.currentWord = problem.en;
        game.currentMeaning = problem.ja;
        game.currentCharIndex = 0;
        game.hasMistyped = false; // ペナルティフラグをリセット
        
        elements.typingInput.value = '';
        elements.typingInput.disabled = false;
        elements.nextButton.disabled = true;
        
        // 和訳を表示
        elements.wordMeaning.textContent = game.currentMeaning;

        // 英単語/英文をレンダリング
        renderWordDisplay();
    }

    /**
     * 英単語/英文表示エリアをレンダリングします。
     */
    function renderWordDisplay() {
        elements.wordDisplay.innerHTML = '';
        const chars = game.currentWord.split('');

        chars.forEach((char, index) => {
            const span = document.createElement('span');
            span.textContent = char;
            span.id = `char-${index}`;

            // 瞬間英作文モードでは、初期状態でスペルを非表示
            if (game.mode === 'instant' && index >= game.currentCharIndex) {
                span.classList.add('hidden-spell');
            }

            // 現在入力すべき文字の処理
            if (index === game.currentCharIndex) {
                span.classList.add('current');
                if (game.mode === 'instant') {
                    span.classList.add('instant-current');
                    span.classList.remove('hidden-spell');
                }
            }
            
            // 既に正しく入力された文字の処理
            if (index < game.currentCharIndex) {
                 span.classList.add('correct');
                 if (game.mode === 'instant') {
                    span.classList.add('instant-correct');
                    span.classList.remove('hidden-spell');
                }
            }

            elements.wordDisplay.appendChild(span);
        });
    }

    /**
     * 入力イベントを処理し、文字の判定を行います。
     * @param {string} inputChar - ユーザーが入力した文字
     */
    function handleInput(inputChar) {
        if (!game.isGameRunning) return;
        
        const targetChar = game.currentWord[game.currentCharIndex];
        const currentCharElement = document.getElementById(`char-${game.currentCharIndex}`);

        if (!currentCharElement) return;

        if (inputChar === targetChar) {
            // 正しい入力
            currentCharElement.classList.remove('incorrect', 'current', 'hidden-spell', 'instant-current');
            currentCharElement.classList.add('correct');
            if (game.mode === 'instant') {
                currentCharElement.classList.add('instant-correct');
            }
            game.currentCharIndex++;
            game.totalTyped++;
            
            // 次の文字へ
            if (game.currentCharIndex < game.currentWord.length) {
                const nextCharElement = document.getElementById(`char-${game.currentCharIndex}`);
                nextCharElement.classList.add('current');
                if (game.mode === 'instant') {
                    nextCharElement.classList.add('instant-current');
                    nextCharElement.classList.remove('hidden-spell'); // スペルを解除
                }
            } else {
                // 文の完了
                finishProblem();
            }

        } else {
            // 間違った入力
            if (!game.hasMistyped) {
                game.timeLeft = Math.max(0, game.timeLeft - 5); // 5秒ペナルティ
                elements.timer.textContent = game.timeLeft;
                game.hasMistyped = true;
            }
            
            // 赤文字でフィードバック
            currentCharElement.classList.remove('correct', 'current', 'instant-current');
            currentCharElement.classList.add('incorrect');
            
            // 間違いがあってもインデックスは進めない（打ち直しを強制）
        }
    }
    
    /**
     * 問題が完了したときの処理を行います。
     */
    function finishProblem() {
        game.score++;
        elements.score.textContent = game.score;
        game.currentProblemIndex++;
        
        // 入力を無効化し、次のボタンを有効化
        elements.typingInput.disabled = true;
        elements.nextButton.disabled = false;
    }


    // --- イベントリスナー ---

    // 入力フィールド（キーダウンイベントで処理を行う）
    elements.typingInput.addEventListener('keydown', (e) => {
        if (!game.isGameRunning || elements.typingInput.disabled) {
            e.preventDefault();
            return;
        }

        const inputChar = e.key;
        
        // Backspace処理
        if (inputChar === 'Backspace' && game.currentCharIndex > 0) {
            e.preventDefault(); // デフォルトのBackSpace動作を抑制
            
            // 現在の文字をリセット（間違っていた場合の色を解除）
            const currentCharElement = document.getElementById(`char-${game.currentCharIndex}`);
            if (currentCharElement) {
                currentCharElement.classList.remove('incorrect', 'current', 'instant-current');
                if (game.mode === 'instant') {
                    currentCharElement.classList.add('hidden-spell');
                }
            }

            game.currentCharIndex--;

            // 戻った文字をハイライトし直し、正解マークを解除
            const prevCharElement = document.getElementById(`char-${game.currentCharIndex}`);
            if (prevCharElement) {
                prevCharElement.classList.remove('correct', 'incorrect', 'instant-correct');
                prevCharElement.classList.add('current');
                if (game.mode === 'instant') {
                    prevCharElement.classList.add('instant-current');
                    prevCharElement.classList.remove('hidden-spell');
                }
            }

            // 入力フィールドのテキストを連動させる
            elements.typingInput.value = game.currentWord.substring(0, game.currentCharIndex);

        } else if (inputChar.length === 1 || inputChar === ' ') {
            // 通常の文字入力 (スペースを含む)
            e.preventDefault(); // デフォルトの入力をキャンセル
            handleInput(inputChar);
        } else if (inputChar === 'Enter') {
             // Enterキーは無視
            e.preventDefault();
        }
    });

    // 次の問題ボタン
    elements.nextButton.addEventListener('click', loadNextProblem);
    
    // 終了ボタン
    elements.endButton.addEventListener('click', endGame);

    // 初期化
    showModeSelection();

</script>
</body>
</html>
