<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Typing Game</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムスタイル */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 1200px;
            min-height: 80vh;
            margin: 40px auto;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 30px;
        }
        /* 単語表示エリアのカスタムスタイル */
        #word-display {
            font-family: 'Consolas', 'Courier New', monospace;
            min-height: 2.5em; 
            user-select: none;
            display: flex; 
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; 
            line-height: 1.2;
            padding: 24px;
            text-align: center;
            word-break: break-word; 
            /* 瞬間英作文モード用のブランク文字のスタイル */
            letter-spacing: 0.1em;
        }
        @media (max-width: 768px) {
            #word-display {
                font-size: 1.5rem;
                padding: 16px;
            }
        }

        .correct { color: #10b981; } /* エメラルドグリーン */
        .incorrect { color: #ef4444; } /* 赤色 */
        .current-char { 
            background-color: #fef08a; /* 黄色のハイライト */
            border-radius: 4px;
            padding: 0 2px;
        }
        /* 瞬間英作文モードで未入力の文字に使うスタイル */
        .blank-char {
            color: #ccc;
        }
        .instant-mode-text {
            /* 瞬間英作文モードのテキストに特に強いフォントを適用 */
            font-size: 1.2rem;
            font-weight: 700;
            color: #4b5563; /* Gray-600 */
        }
    </style>
</head>
<body>

<div id="app" class="container flex flex-col items-center">
    <h1 class="text-4xl font-extrabold text-indigo-600 mb-8">
        English Typing Game
    </h1>

    <!-- 画面切り替えエリア -->
    <div id="screen-container" class="w-full">
        <!-- ホーム画面 (モード選択 + コース選択) -->
        <div id="home-screen" class="space-y-10">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-3">モード選択</h2>
            
            <!-- モード選択ボタン -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- 通常モード -->
                <button onclick="selectMode('normal')" id="btn-normal" class="flex flex-col items-center justify-center p-8 bg-indigo-500 text-white rounded-xl shadow-xl hover:bg-indigo-600 transition-all transform hover:scale-105">
                    <p class="text-3xl font-extrabold mb-2">通常モード</p>
                    <p class="text-lg font-medium text-indigo-100">スペルを見ながら正確に打つ練習</p>
                </button>
                <!-- 瞬間英作文モード -->
                <button onclick="selectMode('instant')" id="btn-instant" class="flex flex-col items-center justify-center p-8 bg-purple-500 text-white rounded-xl shadow-xl hover:bg-purple-600 transition-all transform hover:scale-105">
                    <p class="text-3xl font-extrabold mb-2">瞬間英作文モード</p>
                    <p class="text-lg font-medium text-purple-100">日本語を見てスペルを思い出す練習 (高難度)</p>
                </button>
            </div>
            
            <h2 id="course-selection-title" class="text-2xl font-semibold text-gray-700 mt-10 hidden">コースを選んでください (<span id="selected-mode-display"></span>)</h2>

            <!-- コース選択 (3列グリッド) -->
            <div id="course-selection-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
                <!-- 普通名詞セッション -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">普通名詞セッション</h3>
                    <div id="noun-courses" class="space-y-2"></div>
                </div>

                <!-- 一般動詞セッション -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">一般動詞セッション</h3>
                    <div id="verb-courses" class="space-y-2"></div>
                </div>
                
                <!-- 英文コースセッション (CSVデータに基づく固定文) -->
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">英文コースセッション</h3>
                    <div id="sentence-courses" class="space-y-2">
                        <!-- コース選択メニューが動的に挿入されます -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="hidden space-y-6">
            <div class="flex justify-between items-center w-full mb-4 p-4 bg-indigo-50 rounded-lg shadow-inner">
                <p class="text-lg font-bold text-indigo-700">
                    モード: <span id="current-mode-display"></span> | コース: <span id="current-course-display"></span>
                </p>
                <div class="text-2xl font-extrabold text-red-600 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    残り時間: <span id="timer" class="ml-1">60</span>秒
                </div>
            </div>
            
            <!-- スコア・情報エリア -->
            <div class="flex justify-around text-center mb-6">
                <div class="p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-sm text-green-700">スコア</p>
                    <p id="score" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="p-3 bg-red-100 rounded-lg shadow-md">
                    <p class="text-sm text-red-700">ミスタイプ</p>
                    <p id="mistake-count" class="text-3xl font-bold text-red-600">0</p>
                </div>
                <div class="p-3 bg-yellow-100 rounded-lg shadow-md">
                    <p class="text-sm text-yellow-700">問題</p>
                    <p id="word-progress" class="text-3xl font-bold text-yellow-600">0/0</p>
                </div>
            </div>

            <!-- 単語とUIエリア -->
            <div class="flex flex-col items-center space-y-6 w-full"> 
                
                <!-- 1. 英単語/英文表示エリア (最上部) -->
                <div id="word-display" class="font-extrabold tracking-wider p-6 bg-gray-50 rounded-xl w-full text-center shadow-inner min-h-[3.5em]">
                    Loading...
                </div>
                
                <!-- 2. 日本語の意味 (大きく表示) -->
                <p id="word-meaning" class="text-4xl font-extrabold text-gray-800 mb-4 p-2">日本語の意味</p>
                
                <!-- 3. 入力ボックス -->
                <input type="text" id="typing-input" placeholder="タイプを開始してください" class="w-full md:w-3/4 p-4 text-2xl text-center border-4 border-indigo-400 rounded-xl focus:border-indigo-600 outline-none transition-all duration-300" autofocus disabled>
            </div>
            
            <p id="feedback-message" class="text-center text-lg h-6"></p>

            <button onclick="changeScreen('home')" class="mt-4 px-6 py-2 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors">
                ホームに戻る
            </button>
        </div>
        
        <!-- 結果画面 -->
        <div id="result-screen" class="hidden space-y-6 text-center">
            <h2 class="text-4xl font-extrabold text-green-600">ゲーム終了！</h2>
            <p class="text-2xl text-gray-700">
                あなたの最終スコアは: <span id="final-score" class="text-indigo-600 font-extrabold text-5xl">0</span> ポイントです
            </p>
            <p class="text-xl text-gray-600">
                <span id="completed-words">0</span> / <span id="total-words">0</span> 問題を完了しました。
            </p>
            <button onclick="startGame(GAME_STATE.currentMode, GAME_STATE.selectedSession, GAME_STATE.selectedCourse)" class="mt-8 px-8 py-4 bg-indigo-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">
                このコースで再チャレンジ！
            </button>
            <button onclick="changeScreen('home')" class="mt-4 px-6 py-3 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors block mx-auto">
                コース選択に戻る
            </button>
        </div>
        
    </div>
</div>

<script>
// =========================================================
// 1. データ定義 (英単語 + 英文 全てのコースを固定文で構成)
// =========================================================

const WORD_DATA = {
    // スタンダードな単語セッションはそのまま維持
    "普通名詞セッション": {
        "動物": [
            { word: "dog", meaning: "犬" }, { word: "cat", meaning: "猫" }, { word: "bird", meaning: "鳥" }, { word: "fish", meaning: "魚" }, { word: "horse", meaning: "馬" },
            { word: "lion", meaning: "ライオン" }, { word: "tiger", meaning: "トラ" }, { word: "bear", meaning: "熊" }, { word: "monkey", meaning: "猿" }, { word: "rabbit", meaning: "ウサギ" },
            { word: "mouse", meaning: "ネズミ" }, { word: "sheep", meaning: "羊" }, { word: "goat", meaning: "ヤギ" }, { word: "pig", meaning: "豚" }, { word: "cow", meaning: "牛" },
            { word: "snake", meaning: "蛇" }, { word: "spider", meaning: "クモ" }, { word: "whale", meaning: "クジラ" }, { word: "dolphin", meaning: "イルカ" }, { word: "penguin", meaning: "ペンギン" }
        ],
        "食べ物": [
            { word: "apple", meaning: "りんご" }, { word: "banana", meaning: "バナナ" }, { word: "orange", meaning: "オレンジ" }, { word: "grape", meaning: "ぶどう" }, { word: "rice", meaning: "ご飯" },
            { word: "bread", meaning: "パン" }, { word: "meat", meaning: "肉" }, { word: "egg", meaning: "卵" }, { word: "cheese", meaning: "チーズ" }, { word: "milk", meaning: "牛乳" },
            { word: "pizza", meaning: "ピザ" }, { word: "sushi", meaning: "寿司" }, { word: "salad", meaning: "サラダ" }, { word: "soup", meaning: "スープ" }, { word: "curry", meaning: "カレー" },
            { word: "water", meaning: "水" }, { word: "juice", meaning: "ジュース" }, { word: "coffee", meaning: "コーヒー" }, { word: "sugar", meaning: "砂糖" }, { word: "salt", meaning: "塩" }
        ],
        "家具": [
            { word: "chair", meaning: "椅子" }, { word: "table", meaning: "テーブル" }, { word: "bed", meaning: "ベッド" }, { word: "sofa", meaning: "ソファ" }, { word: "desk", meaning: "机" },
            { word: "shelf", meaning: "棚" }, { word: "lamp", meaning: "ランプ" }, { word: "mirror", meaning: "鏡" }, { word: "clock", meaning: "時計" }, { word: "drawer", meaning: "引き出し" },
            { word: "rug", meaning: "ラグ" }, { word: "door", meaning: "ドア" }, { word: "window", meaning: "窓" }, { word: "curtain", meaning: "カーテン" }, { word: "carpet", meaning: "カーペット" },
            { word: "heater", meaning: "暖房" }, { word: "fan", meaning: "扇風機" }, { word: "picture", meaning: "絵" }, { word: "vases", meaning: "花瓶" }, { word: "cabinet", meaning: "戸棚" }
        ],
        "筆記用具": [
            { word: "pen", meaning: "ペン" }, { word: "pencil", meaning: "鉛筆" }, { word: "eraser", meaning: "消しゴム" }, { word: "notebook", meaning: "ノート" }, { word: "ruler", meaning: "定規" },
            { word: "book", meaning: "本" }, { word: "paper", meaning: "紙" }, { word: "stapler", meaning: "ホッチキス" }, { word: "scissors", meaning: "ハサミ" }, { word: "glue", meaning: "のり" },
            { word: "folder", meaning: "ファイル" }, { word: "marker", meaning: "マーカー" }, { word: "crayon", meaning: "クレヨン" }, { word: "ink", meaning: "インク" }, { word: "clipboard", meaning: "クリップボード" },
            { word: "tape", meaning: "テープ" }, { word: "chalk", meaning: "チョーク" }, { word: "compass", meaning: "コンパス" }, { word: "binder", meaning: "バインダー" }, { word: "highlighter", meaning: "蛍光ペン" }
        ],
        "色": [
            { word: "red", meaning: "赤" }, { word: "blue", meaning: "青" }, { word: "green", meaning: "緑" }, { word: "yellow", meaning: "黄" }, { word: "black", meaning: "黒" },
            { word: "white", meaning: "白" }, { word: "pink", meaning: "ピンク" }, { word: "brown", meaning: "茶色" }, { word: "gray", meaning: "灰色" }, { word: "purple", meaning: "紫" },
            { word: "orange", meaning: "オレンジ" }, { word: "gold", meaning: "金色" }, { word: "silver", meaning: "銀色" }, { word: "navy", meaning: "紺色" }, { word: "beige", meaning: "ベージュ" },
            { word: "sky", meaning: "空色" }, { word: "deep", meaning: "濃い" }, { word: "light", meaning: "薄い" }, { word: "colorful", meaning: "カラフル" }, { word: "transparent", meaning: "透明" }
        ],
        "天気": [
            { word: "sun", meaning: "太陽" }, { word: "rain", meaning: "雨" }, { word: "snow", meaning: "雪" }, { word: "wind", meaning: "風" }, { word: "cloud", meaning: "雲" },
            { word: "storm", meaning: "嵐" }, { word: "fog", meaning: "霧" }, { word: "clear", meaning: "晴れた" }, { word: "warm", meaning: "暖かい" }, { word: "cold", meaning: "寒い" },
            { word: "humid", meaning: "湿気た" }, { word: "forecast", meaning: "予報" }, { word: "rainbow", meaning: "虹" }, { word: "thunder", meaning: "雷" }, { word: "lightning", meaning: "稲妻" },
            { word: "hail", meaning: "ひょう" }, { word: "breeze", meaning: "そよ風" }, { word: "typhoon", meaning: "台風" }, { word: "drizzle", meaning: "霧雨" }, { word: "overcast", meaning: "曇りの" }
        ],
        "体の部位": [
            { word: "head", meaning: "頭" }, { word: "face", meaning: "顔" }, { word: "eye", meaning: "目" }, { word: "ear", meaning: "耳" }, { word: "nose", meaning: "鼻" },
            { word: "mouth", meaning: "口" }, { word: "hand", meaning: "手（手首から下）" }, { word: "foot", meaning: "足（足首から下）" }, { word: "arm", meaning: "腕" }, { word: "leg", meaning: "脚" },
            { word: "stomach", meaning: "胃/腹" }, { word: "neck", meaning: "首" }, { word: "back", meaning: "背中" }, { word: "finger", meaning: "指" }, { word: "hair", meaning: "髪" },
            { word: "teeth", meaning: "歯" }, { word: "shoulder", meaning: "肩" }, { word: "chest", meaning: "胸" }, { word: "knee", meaning: "ひざ" }, { word: "skin", meaning: "肌" }
        ],
        "学校に関するもの": [
            { word: "school", meaning: "学校" }, { word: "teacher", meaning: "先生" }, { word: "student", meaning: "生徒" }, { word: "class", meaning: "授業/クラス" }, { word: "lesson", meaning: "課/レッスン" },
            { word: "homework", meaning: "宿題" }, { word: "test", meaning: "テスト" }, { word: "exam", meaning: "試験" }, { word: "library", meaning: "図書館" }, { word: "gym", meaning: "体育館" },
            { word: "uniform", meaning: "制服" }, { word: "break", meaning: "休み時間" }, { word: "club", meaning: "部活" }, { word: "friend", meaning: "友達" }, { word: "study", meaning: "勉強" },
            { word: "subject", meaning: "科目" }, { word: "history", meaning: "歴史" }, { word: "science", meaning: "科学" }, { word: "math", meaning: "数学" }, { word: "sport", meaning: "スポーツ" }
        ]
    },
    "一般動詞セッション": {
        "コーパストップ２０": [
            { word: "say", meaning: "言う" }, { word: "get", meaning: "得る" }, { word: "make", meaning: "作る" }, { word: "go", meaning: "行く" }, { word: "know", meaning: "知る" },
            { word: "take", meaning: "取る" }, { word: "see", meaning: "見る" }, { word: "come", meaning: "来る" }, { word: "think", meaning: "考える" }, { word: "look", meaning: "見る" },
            { word: "want", meaning: "欲しい" }, { word: "give", meaning: "与える" }, { word: "use", meaning: "使う" }, { word: "find", meaning: "見つける" }, { word: "tell", meaning: "話す" },
            { word: "ask", meaning: "尋ねる" }, { word: "work", meaning: "働く" }, { word: "seem", meaning: "〜のようだ" }, { word: "feel", meaning: "感じる" }, { word: "try", meaning: "試す" }
        ],
        "コーパストップ２０〜４０": [
            { word: "leave", meaning: "去る" }, { word: "call", meaning: "呼ぶ" }, { word: "need", meaning: "必要とする" }, { word: "become", meaning: "〜になる" }, { word: "put", meaning: "置く" },
            { word: "mean", meaning: "意味する" }, { word: "keep", meaning: "保つ" }, { word: "let", meaning: "許可する" }, { word: "begin", meaning: "始める" }, { word: "help", meaning: "助ける" },
            { word: "turn", meaning: "曲がる" }, { word: "start", meaning: "始める" }, { word: "show", meaning: "示す" }, { word: "hear", meaning: "聞く" }, { word: "play", meaning: "遊ぶ" },
            { word: "run", meaning: "走る" }, { word: "move", meaning: "動く" }, { word: "like", meaning: "好きだ" }, { word: "live", meaning: "住む" }, { word: "believe", meaning: "信じる" }
        ],
        "コーパストップ４０〜６０": [
            { word: "bring", meaning: "持ってくる" }, { word: "happen", meaning: "起こる" }, { word: "write", meaning: "書く" }, { word: "provide", meaning: "提供する" }, { word: "sit", meaning: "座る" },
            { word: "stand", meaning: "立つ" }, { word: "lose", meaning: "失う" }, { word: "pay", meaning: "支払う" }, { word: "meet", meaning: "会う" }, { word: "include", meaning: "含む" },
            { word: "continue", meaning: "続ける" }, { word: "set", meaning: "設定する" }, { word: "learn", meaning: "学ぶ" }, { word: "change", meaning: "変える" }, { word: "wait", meaning: "待つ" },
            { word: "watch", meaning: "見守る" }, { word: "follow", meaning: "従う" }, { word: "stop", meaning: "止める" }, { word: "create", meaning: "創造する" }, { word: "speak", meaning: "話す" }
        ],
        "コーパストップ６０〜８０": [
            { word: "read", meaning: "読む" }, { word: "allow", meaning: "許す" }, { word: "add", meaning: "加える" }, { word: "spend", meaning: "費やす" }, { word: "grow", meaning: "育つ" },
            { word: "open", meaning: "開ける" }, { word: "walk", meaning: "歩く" }, { word: "win", meaning: "勝つ" }, { word: "offer", meaning: "提供する" }, { word: "remember", meaning: "思い出す" },
            { word: "love", meaning: "愛する" }, { word: "consider", meaning: "検討する" }, { word: "buy", meaning: "買う" }, { word: "serve", meaning: "奉仕する" }, { word: "die", meaning: "死ぬ" },
            { word: "send", meaning: "送る" }, { word: "build", meaning: "建てる" }, { word: "stay", meaning: "留まる" }, { word: "fall", meaning: "落ちる" }, { word: "cut", meaning: "切る" }
        ],
        "コーパストップ８０〜１００": [
            { word: "reach", meaning: "達する" }, { word: "kill", meaning: "殺す" }, { word: "raise", meaning: "上げる" }, { word: "pass", meaning: "通り過ぎる" }, { word: "sell", meaning: "売る" },
            { word: "decide", meaning: "決定する" }, { word: "return", meaning: "戻る" }, { word: "explain", meaning: "説明する" }, { word: "hope", meaning: "望む" }, { word: "develop", meaning: "発展させる" },
            { word: "carry", meaning: "運ぶ" }, { word: "break", meaning: "壊す" }, { word: "receive", meaning: "受け取る" }, { word: "agree", meaning: "同意する" }, { word: "support", meaning: "支援する" },
            { word: "hit", meaning: "打つ" }, { word: "end", meaning: "終わる" }, { word: "save", meaning: "救う" }, { word: "drive", meaning: "運転する" }, { word: "remain", meaning: "残る" }
        ]
    },
    
    // === 英文コースセッション (CSVデータに基づく固定文) ===
    // テンプレート生成は廃止し、全て固定文に置き換えます。
    "英文コースセッション": {
        // CSVデータから抽出した「パターン１」の文
        "パターン１：「誰が(S)」「する(V)」（S + V / S + V + C）": [
            { word: "I am Edward Trout.", meaning: "私はエドワード・トラウトです。" },
            { word: "Are you an anime fan?", meaning: "あなたはアニメのファンですか。" },
            { word: "Be brave.", meaning: "勇気を出して。" },
            { word: "Don't worry.", meaning: "心配しないで。" },
            { word: "The children look happy.", meaning: "子供たちは幸せそうに見えます。" },
            { word: "Talking with him was fun.", meaning: "彼と話すことは楽しかったです。" },
            { word: "My sister sings well.", meaning: "私の姉は歌が上手です。" },
            { word: "The sky is blue.", meaning: "空は青いです。" },
            { word: "She became a teacher.", meaning: "彼女は先生になりました。" },
            { word: "We work hard.", meaning: "私たちは一生懸命働きます。" },
            { word: "The door opened.", meaning: "ドアが開きました。" },
            { word: "The food tastes salty.", meaning: "その食べ物は塩辛い味がします。" },
            { word: "Everyone smiled.", meaning: "みんなが微笑みました。" }
        ],
        // CSVデータから抽出した仮定法に関連する文（タイトル未指定のため、構造から命名）
        "仮定法（If S were / I wish など）": [ 
            { word: "If I were an animal, I would be a dolphin.", meaning: "もし私が動物なら、イルカになるでしょう。" },
            { word: "If she were here, she would know what to do.", meaning: "もし彼女がここにいれば、何をすべきかわかるだろうに。" },
            { word: "He acts as if he were a leader.", meaning: "彼はまるでリーダーであるかのように振る舞います。" },
            { word: "If it were sunny, we could go hiking.", meaning: "もし晴れていたら、ハイキングに行けるのに。" },
            { word: "I wish I didn't have to work this weekend.", meaning: "今週末、仕事をしなくて済めばいいのに。" },
            { word: "What would you do if you won the lottery?", meaning: "もし宝くじに当たったら、何をしますか。" },
            { word: "If they changed the rule, the game would be better.", meaning: "もし彼らがルールを変えたら、試合はもっとよくなるだろうに。" },
            { word: "I wish I knew the answer to that question.", meaning: "あの質問の答えを知っていればいいのに。" },
            { word: "If I spoke French, I could live in Paris.", meaning: "もし私がフランス語を話せたら、パリに住めるのに。" },
            { word: "She looked as if she hadn't slept for days.", meaning: "彼女はまるで数日間寝ていないかのように見えました。" }
        ]
    }
};

// =========================================================
// 2. 構文テンプレートロジックは削除 (固定文のみ使用のため)
// =========================================================


// =========================================================
// 3. グローバルな状態管理とDOM要素
// =========================================================

const GAME_STATE = {
    currentMode: null, // 'normal' または 'instant'
    selectedSession: null, 
    selectedCourse: null,
    wordList: [],
    currentWordIndex: 0,
    score: 0,
    mistakeCount: 0,
    timer: 60, // 60秒からスタート
    timerInterval: null,
    isGameStarted: false,
    isGameOver: false,
    // 1単語内でのペナルティ適用を管理するフラグ
    currentWordMistakeFlag: false, 
};

const DURATION_PENALTY = 5; // ミスタイプ時のペナルティ秒数
const POINTS_PER_CHARACTER = 10; // 1文字あたりのスコア

// DOM要素の参照
const $ = id => document.getElementById(id);

const elements = {
    home: $('home-screen'),
    game: $('game-screen'),
    result: $('result-screen'),
    
    // Home elements
    courseSelectionTitle: $('course-selection-title'),
    courseSelectionContainer: $('course-selection-container'),
    selectedModeDisplay: $('selected-mode-display'),
    
    // Game elements
    currentModeDisplay: $('current-mode-display'),
    courseDisplay: $('current-course-display'),
    timer: $('timer'),
    score: $('score'),
    mistakeCount: $('mistake-count'),
    wordProgress: $('word-progress'),
    wordMeaning: $('word-meaning'),
    wordDisplay: $('word-display'),
    typingInput: $('typing-input'),
    feedbackMessage: $('feedback-message'),
    
    // Result elements
    finalScore: $('final-score'),
    completedWords: $('completed-words'),
    totalWords: $('total-words'),

    nounCourses: $('noun-courses'),
    verbCourses: $('verb-courses'),
    sentenceCourses: $('sentence-courses')
};


// =========================================================
// 4. UI画面の切り替え
// =========================================================

/**
 * 画面を切り替える
 * @param {('home'|'game'|'result')} screenId - 表示する画面ID
 */
function changeScreen(screenId) {
    elements.home.classList.add('hidden');
    elements.game.classList.add('hidden');
    elements.result.classList.add('hidden');
    
    if (screenId === 'home') {
        elements.home.classList.remove('hidden');
        // モード選択状態に応じてUIを調整
        if (GAME_STATE.currentMode) {
            showCourseSelection();
        } else {
            hideCourseSelection();
        }
    } else if (screenId === 'game') {
        elements.game.classList.remove('hidden');
    } else if (screenId === 'result') {
        elements.result.classList.remove('hidden');
        displayResult();
    }
}


/**
 * モードを選択し、コース選択UIを表示する
 * @param {('normal'|'instant')} mode - 選択されたモード
 */
function selectMode(mode) {
    GAME_STATE.currentMode = mode;
    const modeName = mode === 'normal' ? '通常モード' : '瞬間英作文モード';
    
    elements.selectedModeDisplay.textContent = modeName;
    elements.currentModeDisplay.textContent = modeName;

    // モード選択ボタンを非アクティブ化/アクティブ化
    $('btn-normal').classList.remove('bg-indigo-700');
    $('btn-instant').classList.remove('bg-purple-700');
    
    if (mode === 'normal') {
        $('btn-normal').classList.add('bg-indigo-700');
    } else {
        $('btn-instant').classList.add('bg-purple-700');
    }

    showCourseSelection();
}

function showCourseSelection() {
    elements.courseSelectionTitle.classList.remove('hidden');
    elements.courseSelectionContainer.classList.remove('hidden');
    renderHomeMenu();
}

function hideCourseSelection() {
    elements.courseSelectionTitle.classList.add('hidden');
    elements.courseSelectionContainer.classList.add('hidden');
}

/**
 * コース選択ボタンを作成するヘルパー関数
 */
function createCourseButton(session, courseName, buttonText) {
    const button = document.createElement('button');
    button.className = 'w-full px-4 py-3 text-left bg-indigo-100 text-indigo-800 rounded-lg font-semibold hover:bg-indigo-200 transition-colors shadow-sm';
    button.textContent = buttonText;
    button.onclick = () => {
        startGame(GAME_STATE.currentMode, session, courseName);
    };
    return button;
}

/**
 * ホームメニューのコース選択ボタンを生成する
 */
function renderHomeMenu() {
    elements.nounCourses.innerHTML = '';
    elements.verbCourses.innerHTML = '';
    elements.sentenceCourses.innerHTML = ''; // 英文コースセッションの初期化

    // 普通名詞・一般動詞セッションのレンダリング
    for (const session in WORD_DATA) {
        let targetElement;
        
        if (session === "普通名詞セッション") {
            targetElement = elements.nounCourses;
        } else if (session === "一般動詞セッション") {
            targetElement = elements.verbCourses;
        } else if (session === "英文コースセッション") {
            targetElement = elements.sentenceCourses;
        } else {
            continue;
        }

        for (const courseName in WORD_DATA[session]) {
            const button = createCourseButton(session, courseName, courseName);
            targetElement.appendChild(button);
        }
    }
}


// =========================================================
// 5. ゲームロジック
// =========================================================

/**
 * コースを選択し、ゲーム状態を初期化してゲームを開始する
 * @param {string} mode - 'normal' or 'instant'
 * @param {string} sessionName 
 * @param {string} courseName 
 */
function startGame(mode, sessionName, courseName) {
    // 固定文リストを取得
    let wordList = [];
    if (WORD_DATA[sessionName] && WORD_DATA[sessionName][courseName]) {
        // === 全てのコースは固定データを使用 ===
        wordList = [...WORD_DATA[sessionName][courseName]].sort(() => Math.random() - 0.5); // シャッフル
    } else {
        console.error("Invalid course selection:", sessionName, courseName);
        return;
    }

    // ゲーム状態のリセット
    GAME_STATE.currentMode = mode;
    GAME_STATE.selectedSession = sessionName;
    GAME_STATE.selectedCourse = courseName;
    GAME_STATE.wordList = wordList;
    GAME_STATE.currentWordIndex = 0;
    GAME_STATE.score = 0;
    GAME_STATE.mistakeCount = 0;
    GAME_STATE.timer = 60;
    GAME_STATE.isGameStarted = false;
    GAME_STATE.isGameOver = false;
    GAME_STATE.currentWordMistakeFlag = false; 

    clearInterval(GAME_STATE.timerInterval);
    elements.typingInput.value = '';
    elements.typingInput.disabled = false; // 入力を有効化

    // UIの初期設定
    elements.currentModeDisplay.textContent = mode === 'normal' ? '通常モード' : '瞬間英作文モード';
    // コース表示名を調整
    const courseDisplayName = `${sessionName} / ${courseName}`;
    elements.courseDisplay.textContent = courseDisplayName;
    elements.timer.textContent = GAME_STATE.timer;
    elements.score.textContent = GAME_STATE.score;
    elements.mistakeCount.textContent = GAME_STATE.mistakeCount;
    elements.totalWords.textContent = GAME_STATE.wordList.length;

    // ゲーム開始
    elements.typingInput.focus();
    displayCurrentWord();
    changeScreen('game');

    // 最初の入力でゲームが開始するようにイベントリスナーを設定
    elements.typingInput.onkeydown = startOnFirstKeydown;
}


/**
 * 最初のキー入力でタイマーをスタートさせる
 */
function startOnFirstKeydown(event) {
    if (!GAME_STATE.isGameStarted && !GAME_STATE.isGameOver) {
        // アルファベットキーかスペースキー、記号などが押されたら開始
        if (event.key.length === 1 && event.key.match(/^[a-zA-Z\s,.'";:-]$/)) {
            GAME_STATE.isGameStarted = true;
            elements.typingInput.onkeydown = null; // イベントを解除
            startTimer();
        }
    }
}


/**
 * タイマーを開始する
 */
function startTimer() {
    GAME_STATE.timerInterval = setInterval(() => {
        if (GAME_STATE.timer <= 0) {
            clearInterval(GAME_STATE.timerInterval);
            gameOver();
            return;
        }
        GAME_STATE.timer--;
        elements.timer.textContent = GAME_STATE.timer;
    }, 1000);
}


/**
 * 現在の単語を画面に表示する
 */
function displayCurrentWord() {
    if (GAME_STATE.currentWordIndex >= GAME_STATE.wordList.length) {
        gameOver();
        return;
    }

    const currentWordData = GAME_STATE.wordList[GAME_STATE.currentWordIndex];
    
    // 新しい単語/文が始まったらペナルティフラグをリセット
    GAME_STATE.currentWordMistakeFlag = false; 

    // UIをリセット
    elements.typingInput.value = '';
    elements.typingInput.focus();
    elements.wordMeaning.textContent = currentWordData.meaning;
    elements.wordProgress.textContent = `${GAME_STATE.currentWordIndex} / ${GAME_STATE.wordList.length}`;
    elements.feedbackMessage.textContent = '';
    
    // モードに応じて単語の表示を初期化
    if (GAME_STATE.currentMode === 'normal') {
        // 通常モード: 最初の文字をハイライトして、残りの文字を表示
        elements.wordDisplay.innerHTML = `<span class="current-char">${currentWordData.word.charAt(0)}</span>${currentWordData.word.substring(1)}`;
    } else {
        // 瞬間英作文モード: 全てをブランクで表示 (最初の文字をハイライト)
        let blanks = '';
        for (let i = 0; i < currentWordData.word.length; i++) {
            if (i === 0) {
                // 最初の文字はブランクに見せるが、ハイライトする
                blanks += `<span class="current-char">${currentWordData.word[i] === ' ' ? '&nbsp;' : '_'}</span>`; 
            } else if (currentWordData.word[i] === ' ') {
                blanks += `<span class="blank-char">&nbsp;</span>`; // スペースはそのまま
            } else {
                blanks += `<span class="blank-char">_</span>`;
            }
        }
        elements.wordDisplay.innerHTML = `<p class="instant-mode-text">${blanks}</p>`;
    }
}


/**
 * ユーザーのキー入力を処理する
 */
elements.typingInput.addEventListener('input', () => {
    if (GAME_STATE.isGameOver || !GAME_STATE.isGameStarted) return;
    
    const currentWord = GAME_STATE.wordList[GAME_STATE.currentWordIndex].word;
    let typedText = elements.typingInput.value;
    let isMistake = false;

    // リアルタイムでの文字色ハイライトとミス判定
    let highlightedWord = '';
    
    for (let i = 0; i < currentWord.length; i++) {
        let char = currentWord[i];
        
        if (i < typedText.length) {
            if (char === typedText[i]) {
                // 正しい文字
                highlightedWord += `<span class="correct">${char}</span>`;
            } else {
                // 間違い検出
                if (GAME_STATE.currentMode === 'normal') {
                    // 通常モード: 間違った文字を赤くハイライト
                    highlightedWord += `<span class="incorrect">${char}</span>`;
                } else {
                    // 瞬間英作文モード: 間違った文字を赤くハイライト（フィードバックのため）
                    highlightedWord += `<span class="incorrect">${char}</span>`;
                }
                isMistake = true;
                break; // 最初の間違いでループを中断
            }
        } else if (i === typedText.length) {
            // 次に入力すべき文字 (現在カーソルがある位置)
            if (GAME_STATE.currentMode === 'normal') {
                highlightedWord += `<span class="current-char">${char}</span>`;
            } else {
                // 瞬間英作文モード: ブランク（_）で表示
                highlightedWord += `<span class="current-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        } else {
            // 未入力の文字
            if (GAME_STATE.currentMode === 'normal') {
                highlightedWord += char;
            } else {
                 // 瞬間英作文モード: ブランク（_）で表示
                highlightedWord += `<span class="blank-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        }
    }
    
    // 間違いが検出された場合、未入力部分の表示を調整
    if (isMistake && typedText.length < currentWord.length) {
        let remaining = currentWord.substring(typedText.length + 1); // 間違えた文字の次から
        
        for (let i = 0; i < remaining.length; i++) {
            let char = remaining[i];
            if (GAME_STATE.currentMode === 'normal') {
                 highlightedWord += char;
            } else {
                highlightedWord += `<span class="blank-char">${char === ' ' ? '&nbsp;' : '_'}</span>`;
            }
        }
    }


    // ハイライト表示の更新
    // 瞬間英作文モードでは、正しい入力中のみブランクを埋めるように見せる
    if (GAME_STATE.currentMode === 'instant' && !isMistake) {
        elements.wordDisplay.innerHTML = `<p class="instant-mode-text">${highlightedWord}</p>`;
    } else {
        elements.wordDisplay.innerHTML = highlightedWord;
    }


    if (isMistake) {
        // === ミスタイプ時のペナルティ処理 ===
        
        // 1単語内でまだペナルティを適用していない場合のみ実行
        if (!GAME_STATE.currentWordMistakeFlag) {
            GAME_STATE.mistakeCount++;
            elements.mistakeCount.textContent = GAME_STATE.mistakeCount;
            GAME_STATE.timer = Math.max(0, GAME_STATE.timer - DURATION_PENALTY); // 時間をマイナス5秒
            elements.timer.textContent = GAME_STATE.timer;
            elements.feedbackMessage.innerHTML = `<span class="text-red-500 font-bold">ミス！ -${DURATION_PENALTY}秒ペナルティ (修正して続行)</span>`;
            
            // ペナルティフラグを立てる
            GAME_STATE.currentWordMistakeFlag = true;

            if (GAME_STATE.timer <= 0) {
                clearInterval(GAME_STATE.timerInterval);
                gameOver();
            }
        }
        
    } else {
        elements.feedbackMessage.textContent = '';
        
        if (typedText.length === currentWord.length) {
            // === 単語完了時の処理 ===
            if (typedText === currentWord) {
                GAME_STATE.score += currentWord.length * POINTS_PER_CHARACTER;
                elements.score.textContent = GAME_STATE.score;
                elements.feedbackMessage.innerHTML = `<span class="text-green-500 font-bold">PERFECT! +${currentWord.length * POINTS_PER_CHARACTER}ポイント</span>`;
                
                // 次の単語へ
                GAME_STATE.currentWordIndex++;
                
                // わずかな遅延後、次の単語を表示
                setTimeout(() => {
                    displayCurrentWord();
                }, 500);
            }
        }
    }
});


/**
 * ゲームオーバー処理
 */
function gameOver() {
    if (GAME_STATE.isGameOver) return;
    
    GAME_STATE.isGameOver = true;
    GAME_STATE.isGameStarted = false;
    clearInterval(GAME_STATE.timerInterval);
    elements.typingInput.disabled = true;

    changeScreen('result');
}

/**
 * 結果画面の表示を更新する
 */
function displayResult() {
    elements.finalScore.textContent = GAME_STATE.score;
    elements.completedWords.textContent = GAME_STATE.currentWordIndex;
    elements.totalWords.textContent = GAME_STATE.wordList.length;
}


// =========================================================
// 6. 初期化
// =========================================================

// ページロード時にホーム画面を表示
window.onload = function() {
    // 初期状態ではモード選択のみ表示
    hideCourseSelection();
    changeScreen('home');
};

</script>
